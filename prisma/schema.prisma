// Prisma Schema - Product 3D Customizer & Upload
// Tenant-scoped multi-shop model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════
// SESSIONS (Shopify OAuth)
// ══════════════════════════════════════════════════════════════
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false) @map("is_online")
  scope         String?
  expires       DateTime?
  accessToken   String?   @map("access_token")
  userId        BigInt?   @map("user_id")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  email         String?
  accountOwner  Boolean   @default(false) @map("account_owner")
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false) @map("email_verified")

  @@map("sessions")
}

// ══════════════════════════════════════════════════════════════
// SHOPS (Tenant)
// ══════════════════════════════════════════════════════════════
model Shop {
  id              String @id @default(cuid())
  shopDomain      String @unique @map("shop_domain")
  accessToken     String @map("access_token")
  plan            String @default("free") // free, starter, pro, enterprise
  billingStatus   String @default("active") @map("billing_status")
  storageProvider String @default("local") @map("storage_provider") // local only (R2/S3/Shopify removed)
  storageConfig   Json?  @map("storage_config_json") // deprecated - kept for migration
  settings        Json?  @map("settings_json")

  // Onboarding
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  onboardingStep      Int     @default(0) @map("onboarding_step") // 0-5
  onboardingData      Json?   @map("onboarding_data_json")

  installedAt DateTime @default(now()) @map("installed_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  productsConfig   ProductConfig[]
  assetSets        AssetSet[]
  uploads          Upload[]
  ordersLink       OrderLink[]
  exportJobs       ExportJob[]
  auditLogs        AuditLog[]
  teamMembers      TeamMember[]
  apiKeys          ApiKey[]
  whiteLabelConfig WhiteLabelConfig?
  flowTriggers     FlowTrigger[]
  visitors         Visitor[]
  visitorSessions  VisitorSession[]

  @@map("shops")
}

// ══════════════════════════════════════════════════════════════
// PRODUCT CONFIG
// ══════════════════════════════════════════════════════════════
model ProductConfig {
  id        String @id @default(cuid())
  shopId    String @map("shop_id")
  productId String @map("product_id") // Shopify product GID

  // Upload Settings
  uploadEnabled Boolean @default(true) @map("upload_enabled")

  // Extra Questions (dynamic form fields for customer)
  // Format: [{ id, type: "text"|"select"|"checkbox", label, options?, required? }]
  extraQuestions Json? @map("extra_questions_json")

  // T-Shirt Addon Settings
  tshirtEnabled Boolean @default(false) @map("tshirt_enabled")
  tshirtConfig  Json?   @map("tshirt_config_json")
  // Format: { 
  //   colorVariantOption: "Color",  // Shopify option name for color
  //   sizeVariantOption: "Size",    // Shopify option name for size
  //   priceAddon: 15.00,            // Extra price for t-shirt
  //   positions: ["front", "back"]  // Available print positions
  // }

  // Legacy fields (keeping for compatibility)
  mode            String  @default("dtf") // dtf (default), legacy modes: 3d_designer, classic, quick
  enabled         Boolean @default(true)
  assetSetId      String? @map("asset_set_id")
  policyOverrides Json?   @map("policy_overrides_json")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shop     Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  assetSet AssetSet? @relation(fields: [assetSetId], references: [id])

  @@unique([shopId, productId])
  @@map("products_config")
}

// ══════════════════════════════════════════════════════════════
// ASSET SETS (3D Models + Print Locations)
// ══════════════════════════════════════════════════════════════
model AssetSet {
  id           String   @id @default(cuid())
  shopId       String   @map("shop_id")
  name         String
  schema       Json     @map("schema_json") // printLocations, camera, render preset
  thumbnailUrl String?  @map("thumbnail_url")
  status       String   @default("active") // active, archived
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  shop           Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productsConfig ProductConfig[]

  @@map("asset_sets")
}

// ══════════════════════════════════════════════════════════════
// UPLOADS
// ══════════════════════════════════════════════════════════════
model Upload {
  id               String    @id @default(cuid())
  shopId           String    @map("shop_id")
  productId        String?   @map("product_id")
  variantId        String?   @map("variant_id")
  orderId          String?   @map("order_id")
  mode             String // 3d_designer, classic, quick
  status           String    @default("draft") // draft, uploaded, processing, needs_review, approved, rejected, blocked, printed, archived
  customerId       String?   @map("customer_id")
  customerEmail    String?   @map("customer_email")
  preflightSummary Json?     @map("preflight_summary_json")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  approvedAt       DateTime? @map("approved_at")
  rejectedAt       DateTime? @map("rejected_at")

  // ─────────────────────────────────────────────────────────────
  // Visitor Tracking (NULLABLE - backward compatible)
  // ─────────────────────────────────────────────────────────────
  visitorId String? @map("visitor_id")
  sessionId String? @map("session_id")

  // ─────────────────────────────────────────────────────────────
  // Revenue Attribution (NULLABLE - for analytics)
  // ─────────────────────────────────────────────────────────────
  cartAddedAt   DateTime? @map("cart_added_at")
  orderPaidAt   DateTime? @map("order_paid_at")
  orderTotal    Decimal?  @map("order_total") @db.Decimal(10, 2)
  orderCurrency String?   @map("order_currency") // USD, EUR, etc.

  // Relations
  shop       Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  items      UploadItem[]
  ordersLink OrderLink[]
  visitor    Visitor?        @relation(fields: [visitorId], references: [id], onDelete: SetNull)
  session    VisitorSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([shopId, status])
  @@index([shopId, createdAt])
  @@index([visitorId])
  @@index([sessionId])
  @@index([orderPaidAt])
  @@map("uploads")
}

// ══════════════════════════════════════════════════════════════
// UPLOAD ITEMS (per location)
// ══════════════════════════════════════════════════════════════
model UploadItem {
  id              String   @id @default(cuid())
  uploadId        String   @map("upload_id")
  location        String // front, back, left_sleeve, right_sleeve
  storageKey      String   @map("storage_key")
  previewKey      String?  @map("preview_key")
  thumbnailKey    String?  @map("thumbnail_key")
  originalName    String?  @map("original_name")
  mimeType        String?  @map("mime_type")
  fileSize        Int?     @map("file_size")
  uploadDurationMs Int?    @map("upload_duration_ms") // Upload time in milliseconds
  transform       Json?    @map("transform_json") // scale, rotation, position
  preflightStatus String   @default("pending") @map("preflight_status") // pending, ok, warning, error
  preflightResult Json?    @map("preflight_result_json")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  upload Upload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@map("upload_items")
}

// ══════════════════════════════════════════════════════════════
// ORDER LINKS
// ══════════════════════════════════════════════════════════════
model OrderLink {
  id         String   @id @default(cuid())
  shopId     String   @map("shop_id")
  orderId    String   @map("order_id")
  uploadId   String   @map("upload_id")
  lineItemId String?  @map("line_item_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  upload Upload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  // WI-007: Named unique constraint for idempotent upsert
  @@unique([orderId, uploadId], name: "orderId_uploadId")
  @@map("orders_link")
}

// ══════════════════════════════════════════════════════════════
// EXPORT JOBS
// ══════════════════════════════════════════════════════════════
model ExportJob {
  id          String    @id @default(cuid())
  shopId      String    @map("shop_id")
  uploadIds   String[]  @map("upload_ids")
  status      String    @default("pending") // pending, processing, completed, failed, expired
  downloadUrl String?   @map("download_url")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("export_jobs")
}

// ══════════════════════════════════════════════════════════════
// AUDIT LOGS
// ══════════════════════════════════════════════════════════════
model AuditLog {
  id           String   @id @default(cuid())
  shopId       String   @map("shop_id")
  userId       String?  @map("user_id")
  action       String // create, update, delete, approve, reject, export
  resourceType String   @map("resource_type") // upload, product_config, asset_set, etc.
  resourceId   String?  @map("resource_id")
  metadata     Json?    @map("metadata_json")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
  @@map("audit_logs")
}

// ══════════════════════════════════════════════════════════════
// TEAM MEMBERS (RBAC)
// ══════════════════════════════════════════════════════════════
model TeamMember {
  id          String    @id @default(cuid())
  shopId      String    @map("shop_id")
  email       String
  name        String?
  role        String    @default("viewer") // owner, admin, operator, viewer
  inviteToken String?   @map("invite_token")
  invitedAt   DateTime  @default(now()) @map("invited_at")
  acceptedAt  DateTime? @map("accepted_at")
  lastLoginAt DateTime? @map("last_login_at")
  status      String    @default("pending") // pending, active, suspended
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, email])
  @@map("team_members")
}

// ══════════════════════════════════════════════════════════════
// API KEYS (Public API)
// ══════════════════════════════════════════════════════════════
model ApiKey {
  id          String    @id @default(cuid())
  shopId      String    @map("shop_id")
  name        String
  keyHash     String    @map("key_hash") // SHA256 hash of the key
  keyPrefix   String    @map("key_prefix") // First 8 chars for display
  permissions String[] // Array of allowed permissions
  rateLimit   Int       @default(100) @map("rate_limit") // Requests per minute
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  usageCount  Int       @default(0) @map("usage_count")
  status      String    @default("active") // active, revoked
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@map("api_keys")
}

// ══════════════════════════════════════════════════════════════
// WHITE LABEL SETTINGS
// ══════════════════════════════════════════════════════════════
model WhiteLabelConfig {
  id             String   @id @default(cuid())
  shopId         String   @unique @map("shop_id")
  enabled        Boolean  @default(false)
  logoUrl        String?  @map("logo_url")
  primaryColor   String?  @map("primary_color") // Hex color
  secondaryColor String?  @map("secondary_color")
  customCss      String?  @map("custom_css")
  hideBranding   Boolean  @default(false) @map("hide_branding")
  customDomain   String?  @map("custom_domain")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("white_label_config")
}

// ══════════════════════════════════════════════════════════════
// FLOW TRIGGERS LOG
// ══════════════════════════════════════════════════════════════
model FlowTrigger {
  id         String    @id @default(cuid())
  shopId     String    @map("shop_id")
  eventType  String    @map("event_type") // upload_received, upload_approved, etc.
  resourceId String    @map("resource_id")
  payload    Json      @map("payload_json")
  status     String    @default("pending") // pending, sent, failed
  attempts   Int       @default(0)
  sentAt     DateTime? @map("sent_at")
  error      String?
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, eventType])
  @@map("flow_triggers")
}

// ══════════════════════════════════════════════════════════════
// SUPPORT TICKETS
// ══════════════════════════════════════════════════════════════
model SupportTicket {
  id           String @id @default(cuid())
  ticketNumber String @unique @map("ticket_number") // UL-XXXXX format

  // Contact Info
  name       String
  email      String
  shopDomain String? @map("shop_domain") // If logged in merchant

  // Ticket Details
  category String // general, support, billing, feature, bug, partnership, gdpr
  subject  String
  message  String @db.Text

  // Status
  status   String @default("open") // open, in_progress, resolved, closed
  priority String @default("normal") // low, normal, high, urgent

  // Assignment
  assignedTo String? @map("assigned_to")

  // Tracking
  emailSentAt  DateTime? @map("email_sent_at")
  firstReplyAt DateTime? @map("first_reply_at")
  resolvedAt   DateTime? @map("resolved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  replies SupportReply[]

  @@index([email])
  @@index([status])
  @@index([shopDomain])
  @@map("support_tickets")
}

model SupportReply {
  id       String @id @default(cuid())
  ticketId String @map("ticket_id")

  // Reply Details
  message     String  @db.Text
  isStaff     Boolean @default(false) @map("is_staff") // true if from support team
  authorName  String  @map("author_name")
  authorEmail String  @map("author_email")

  // Email tracking
  emailSentAt DateTime? @map("email_sent_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("support_replies")
}

// ══════════════════════════════════════════════════════════════
// VISITOR (Cross-session user identification)
// ══════════════════════════════════════════════════════════════
model Visitor {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  // ─────────────────────────────────────────────────────────────
  // Identification Fields
  // ─────────────────────────────────────────────────────────────
  fingerprint    String? // FingerprintJS hash (null if degraded mode)
  localStorageId String  @map("local_storage_id") // Client-generated UUID

  // ─────────────────────────────────────────────────────────────
  // Device Information (first seen values)
  // ─────────────────────────────────────────────────────────────
  deviceType       String? @map("device_type") // desktop, mobile, tablet
  browser          String? // Chrome, Firefox, Safari
  browserVersion   String? @map("browser_version")
  os               String? // Windows, macOS, iOS, Android
  osVersion        String? @map("os_version")
  screenResolution String? @map("screen_resolution") // 1920x1080
  language         String? // navigator.language (en-US)
  timezone         String? // Intl.DateTimeFormat timezone

  // ─────────────────────────────────────────────────────────────
  // Geolocation (from Cloudflare/Caddy headers)
  // ─────────────────────────────────────────────────────────────
  country String? // ISO 3166-1 alpha-2 (US, TR, DE)
  region  String? // State/Province
  city    String?

  // ─────────────────────────────────────────────────────────────
  // Lifecycle & Metrics (aggregated for quick queries)
  // ─────────────────────────────────────────────────────────────
  firstSeenAt   DateTime @default(now()) @map("first_seen_at")
  lastSeenAt    DateTime @updatedAt @map("last_seen_at")
  totalSessions Int      @default(1) @map("total_sessions")
  totalUploads  Int      @default(0) @map("total_uploads")
  totalOrders   Int      @default(0) @map("total_orders")
  totalRevenue  Decimal? @map("total_revenue") @db.Decimal(10, 2)

  // ─────────────────────────────────────────────────────────────
  // Privacy & Consent
  // ─────────────────────────────────────────────────────────────
  consentGiven     Boolean   @default(false) @map("consent_given")
  consentTimestamp DateTime? @map("consent_timestamp")
  degradedMode     Boolean   @default(false) @map("degraded_mode") // No fingerprint consent

  // ─────────────────────────────────────────────────────────────
  // Shopify Customer Link (when customer logs in)
  // ─────────────────────────────────────────────────────────────
  shopifyCustomerId String? @map("shopify_customer_id") // Shopify customer GID
  customerEmail     String? @map("customer_email")

  // ─────────────────────────────────────────────────────────────
  // Relationships
  // ─────────────────────────────────────────────────────────────
  shop     Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  sessions VisitorSession[]
  uploads  Upload[]

  // ─────────────────────────────────────────────────────────────
  // Indexes - Tenant-scoped queries
  // ─────────────────────────────────────────────────────────────
  @@unique([shopId, fingerprint], name: "visitor_shop_fingerprint")
  @@unique([shopId, localStorageId], name: "visitor_shop_localStorage")
  @@index([shopId, firstSeenAt])
  @@index([shopId, country])
  @@index([shopId, shopifyCustomerId])
  @@map("visitors")
}

// ══════════════════════════════════════════════════════════════
// VISITOR SESSION (Individual visit tracking with attribution)
// ══════════════════════════════════════════════════════════════
model VisitorSession {
  id        String @id @default(cuid())
  shopId    String @map("shop_id")
  visitorId String @map("visitor_id")

  // ─────────────────────────────────────────────────────────────
  // Session Identification
  // ─────────────────────────────────────────────────────────────
  sessionToken String @map("session_token") // Client-generated session ID

  // ─────────────────────────────────────────────────────────────
  // Attribution (UTM Parameters) - First-touch for this session
  // ─────────────────────────────────────────────────────────────
  utmSource   String? @map("utm_source") // google, facebook, newsletter
  utmMedium   String? @map("utm_medium") // cpc, email, social, organic
  utmCampaign String? @map("utm_campaign") // spring_sale_2024
  utmTerm     String? @map("utm_term") // paid keywords
  utmContent  String? @map("utm_content") // A/B test variant

  // ─────────────────────────────────────────────────────────────
  // Click IDs (auto-detected from URL)
  // ─────────────────────────────────────────────────────────────
  gclid   String? // Google Ads
  fbclid  String? // Facebook/Meta
  msclkid String? // Microsoft/Bing
  ttclid  String? // TikTok

  // ─────────────────────────────────────────────────────────────
  // Referrer & Landing
  // ─────────────────────────────────────────────────────────────
  referrer       String? @db.Text // document.referrer
  referrerDomain String? @map("referrer_domain") // Parsed domain
  referrerType   String? @map("referrer_type") // direct, organic_search, paid_search, social, email, referral
  landingPage    String? @map("landing_page") @db.Text // First page URL
  landingPath    String? @map("landing_path") // Parsed path (/products/custom-tshirt)

  // ─────────────────────────────────────────────────────────────
  // Session Lifecycle
  // ─────────────────────────────────────────────────────────────
  startedAt      DateTime @default(now()) @map("started_at")
  lastActivityAt DateTime @updatedAt @map("last_activity_at")

  // ─────────────────────────────────────────────────────────────
  // Session Metrics (aggregated)
  // ─────────────────────────────────────────────────────────────
  pageViews        Int @default(1) @map("page_views")
  uploadsInSession Int @default(0) @map("uploads_in_session")
  addToCartCount   Int @default(0) @map("add_to_cart_count")

  // ─────────────────────────────────────────────────────────────
  // Relationships
  // ─────────────────────────────────────────────────────────────
  shop    Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  visitor Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  uploads Upload[]

  // ─────────────────────────────────────────────────────────────
  // Indexes
  // ─────────────────────────────────────────────────────────────
  @@unique([shopId, sessionToken], name: "session_shop_token")
  @@index([shopId, startedAt])
  @@index([shopId, utmSource])
  @@index([shopId, utmCampaign])
  @@index([shopId, referrerType])
  @@index([visitorId])
  @@map("visitor_sessions")
}
