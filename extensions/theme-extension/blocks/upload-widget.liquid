{% comment %}
  Upload Lift Pro - Unified Upload Widget
  Supports: DTF Transfer Mode + T-Shirt 3D Mode
  Version: 2.0.0
{% endcomment %}

{% liquid
  assign api_base = "https://customizerapp.dev"
  assign shop_domain = shop.permanent_domain
  assign product_id = product.id
  assign current_variant = product.selected_or_first_available_variant
  
  # Widget settings from block schema
  assign widget_mode = block.settings.mode | default: 'dtf'
  assign show_3d_preview = block.settings.show_3d_preview | default: false
  assign preview_display = block.settings.preview_display | default: 'popup'
  assign upload_label = block.settings.upload_label | default: 'Upload Your Design'
  assign primary_color = block.settings.primary_color | default: '#6366f1'
  assign max_file_size_mb = block.settings.max_file_size_mb | default: 25
%}

<style>
  :root {
    --ul-primary: {{ primary_color }};
    --ul-primary-hover: {{ primary_color | color_darken: 10 }};
    --ul-bg: #ffffff;
    --ul-border: #e5e7eb;
    --ul-text: #1f2937;
    --ul-text-muted: #6b7280;
    --ul-success: #10b981;
    --ul-error: #ef4444;
    --ul-radius: 12px;
  }

  .ul-widget {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--ul-bg);
    border: 1px solid var(--ul-border);
    border-radius: var(--ul-radius);
    padding: 20px;
    margin: 16px 0;
  }

  .ul-section {
    margin-bottom: 20px;
  }

  .ul-section:last-child {
    margin-bottom: 0;
  }

  .ul-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .ul-step-number {
    width: 24px;
    height: 24px;
    background: var(--ul-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
  }

  .ul-section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--ul-text);
  }

  /* Dropzone */
  .ul-dropzone {
    border: 2px dashed var(--ul-border);
    border-radius: var(--ul-radius);
    padding: 32px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafafa;
  }

  .ul-dropzone:hover,
  .ul-dropzone.dragover {
    border-color: var(--ul-primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .ul-dropzone-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    opacity: 0.5;
  }

  .ul-dropzone-text {
    font-size: 14px;
    color: var(--ul-text);
    margin-bottom: 4px;
  }

  .ul-dropzone-hint {
    font-size: 12px;
    color: var(--ul-text-muted);
  }

  .ul-dropzone input[type="file"] {
    display: none;
  }

  /* Upload preview */
  .ul-upload-preview {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f0fdf4;
    border: 1px solid #86efac;
    border-radius: var(--ul-radius);
  }

  .ul-upload-preview.active {
    display: flex;
  }

  .ul-upload-preview img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid var(--ul-border);
  }

  .ul-upload-info {
    flex: 1;
  }

  .ul-upload-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--ul-text);
    margin-bottom: 2px;
  }

  .ul-upload-size {
    font-size: 12px;
    color: var(--ul-text-muted);
  }

  .ul-upload-status {
    font-size: 12px;
    color: var(--ul-success);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .ul-upload-remove {
    background: none;
    border: none;
    color: var(--ul-error);
    cursor: pointer;
    padding: 4px;
  }

  /* Progress bar */
  .ul-progress {
    display: none;
    margin-top: 12px;
  }

  .ul-progress.active {
    display: block;
  }

  .ul-progress-bar {
    height: 4px;
    background: var(--ul-border);
    border-radius: 2px;
    overflow: hidden;
  }

  .ul-progress-fill {
    height: 100%;
    background: var(--ul-primary);
    transition: width 0.3s;
    width: 0%;
  }

  .ul-progress-text {
    font-size: 12px;
    color: var(--ul-text-muted);
    margin-top: 4px;
    text-align: center;
  }

  /* Position selector */
  .ul-positions {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .ul-position-btn {
    border: 2px solid var(--ul-border);
    border-radius: var(--ul-radius);
    padding: 12px 8px;
    background: var(--ul-bg);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .ul-position-btn:hover {
    border-color: var(--ul-primary);
  }

  .ul-position-btn.selected {
    border-color: var(--ul-primary);
    background: rgba(99, 102, 241, 0.05);
  }

  .ul-position-img {
    width: 60px;
    height: 60px;
    margin: 0 auto 8px;
    background: #f3f4f6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .ul-position-label {
    font-size: 12px;
    color: var(--ul-text);
    font-weight: 500;
  }

  /* Size controls */
  .ul-size-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    align-items: end;
  }

  .ul-input-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .ul-input-group label {
    font-size: 12px;
    color: var(--ul-text-muted);
  }

  .ul-input-group input {
    border: 1px solid var(--ul-border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
  }

  .ul-input-group input:focus {
    outline: none;
    border-color: var(--ul-primary);
  }

  /* Position sliders */
  .ul-slider-group {
    margin-top: 16px;
  }

  .ul-slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .ul-slider-label {
    width: 50px;
    font-size: 12px;
    color: var(--ul-text-muted);
  }

  .ul-slider-row input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    height: 6px;
    border-radius: 3px;
    background: var(--ul-border);
  }

  .ul-slider-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--ul-primary);
    cursor: pointer;
  }

  .ul-slider-value {
    width: 40px;
    font-size: 12px;
    color: var(--ul-text);
    text-align: right;
  }

  /* T-Shirt preview button */
  .ul-3d-preview-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    border: 2px dashed var(--ul-primary);
    border-radius: var(--ul-radius);
    background: rgba(99, 102, 241, 0.05);
    color: var(--ul-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .ul-3d-preview-btn:hover {
    background: rgba(99, 102, 241, 0.1);
  }

  /* Extra options */
  .ul-option-group {
    margin-bottom: 12px;
  }

  .ul-option-group label {
    display: block;
    font-size: 13px;
    color: var(--ul-text);
    margin-bottom: 6px;
  }

  .ul-option-group select {
    width: 100%;
    border: 1px solid var(--ul-border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
    background: var(--ul-bg);
    cursor: pointer;
  }

  /* Error messages */
  .ul-error {
    display: none;
    padding: 12px;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--ul-radius);
    color: var(--ul-error);
    font-size: 13px;
    margin-bottom: 16px;
  }

  .ul-error.active {
    display: block;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .ul-positions {
      grid-template-columns: repeat(2, 1fr);
    }

    .ul-size-grid {
      grid-template-columns: 1fr 1fr;
    }

    .ul-size-grid .ul-input-group:last-child {
      grid-column: span 2;
    }
  }
</style>

<div 
  id="ul-widget-{{ block.id }}" 
  class="ul-widget"
  data-api-base="{{ api_base }}"
  data-shop-domain="{{ shop_domain }}"
  data-product-id="{{ product_id }}"
  data-variant-id="{{ current_variant.id }}"
  data-mode="{{ widget_mode }}"
  data-show-3d="{{ show_3d_preview }}"
  data-preview-display="{{ preview_display }}"
  data-max-size="{{ max_file_size_mb }}"
>
  <!-- Error Display -->
  <div class="ul-error" id="ul-error-{{ block.id }}"></div>

  <!-- Step 1: Upload -->
  <div class="ul-section">
    <div class="ul-section-header">
      <span class="ul-step-number">1</span>
      <span class="ul-section-title">{{ upload_label }}</span>
    </div>

    <div class="ul-dropzone" id="ul-dropzone-{{ block.id }}">
      <input type="file" id="ul-file-{{ block.id }}" accept=".png,.jpg,.jpeg,.pdf,.ai,.svg,.webp">
      <svg class="ul-dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 16V4m0 0l-4 4m4-4l4 4M4 20h16" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div class="ul-dropzone-text">Drag your design here</div>
      <div class="ul-dropzone-hint">or click to browse (PNG, JPG, PDF)</div>
    </div>

    <div class="ul-upload-preview" id="ul-preview-{{ block.id }}">
      <img id="ul-preview-img-{{ block.id }}" src="" alt="Preview">
      <div class="ul-upload-info">
        <div class="ul-upload-name" id="ul-filename-{{ block.id }}">design.png</div>
        <div class="ul-upload-size" id="ul-filesize-{{ block.id }}">2.4 MB</div>
        <div class="ul-upload-status" id="ul-status-{{ block.id }}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Uploaded</span>
        </div>
      </div>
      <button class="ul-upload-remove" id="ul-remove-{{ block.id }}" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="ul-progress" id="ul-progress-{{ block.id }}">
      <div class="ul-progress-bar">
        <div class="ul-progress-fill" id="ul-progress-fill-{{ block.id }}"></div>
      </div>
      <div class="ul-progress-text" id="ul-progress-text-{{ block.id }}">Uploading...</div>
    </div>
  </div>

  {% if widget_mode == 'tshirt' or show_3d_preview %}
    <!-- Step 2: Print Position (T-Shirt mode only) -->
    <div class="ul-section" id="ul-positions-section-{{ block.id }}">
      <div class="ul-section-header">
        <span class="ul-step-number">2</span>
        <span class="ul-section-title">Select Print Position</span>
      </div>

      <div class="ul-positions">
        <button class="ul-position-btn selected" data-position="front" type="button">
          <div class="ul-position-img">ðŸ‘•</div>
          <div class="ul-position-label">Front Body</div>
        </button>
        <button class="ul-position-btn" data-position="back" type="button">
          <div class="ul-position-img">ðŸ‘•</div>
          <div class="ul-position-label">Back Body</div>
        </button>
        <button class="ul-position-btn" data-position="left_sleeve" type="button">
          <div class="ul-position-img">ðŸ’ª</div>
          <div class="ul-position-label">Left Sleeve</div>
        </button>
        <button class="ul-position-btn" data-position="right_sleeve" type="button">
          <div class="ul-position-img">ðŸ’ª</div>
          <div class="ul-position-label">Right Sleeve</div>
        </button>
      </div>

      <!-- Position sliders -->
      <div class="ul-slider-group">
        <div class="ul-slider-row">
          <span class="ul-slider-label">â†” X Pos</span>
          <input type="range" id="ul-xpos-{{ block.id }}" min="-1" max="1" step="0.01" value="0">
          <span class="ul-slider-value" id="ul-xpos-val-{{ block.id }}">0</span>
        </div>
        <div class="ul-slider-row">
          <span class="ul-slider-label">â†• Y Pos</span>
          <input type="range" id="ul-ypos-{{ block.id }}" min="-1" max="1" step="0.01" value="0">
          <span class="ul-slider-value" id="ul-ypos-val-{{ block.id }}">0</span>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Step 3: Design Size -->
  <div class="ul-section">
    <div class="ul-section-header">
      <span class="ul-step-number">{% if widget_mode == 'tshirt' or show_3d_preview %}3{% else %}2{% endif %}</span>
      <span class="ul-section-title">Set Design Size</span>
    </div>

    <div class="ul-size-grid">
      <div class="ul-input-group">
        <label for="ul-width-{{ block.id }}">Width (inch)</label>
        <input type="number" id="ul-width-{{ block.id }}" value="9" min="1" max="22" step="0.1">
      </div>
      <div class="ul-input-group">
        <label for="ul-height-{{ block.id }}">Height (inch)</label>
        <input type="number" id="ul-height-{{ block.id }}" value="9" min="1" max="22" step="0.1">
      </div>
      <div class="ul-input-group">
        <label for="ul-quantity-{{ block.id }}">Quantity</label>
        <input type="number" id="ul-quantity-{{ block.id }}" value="1" min="1" max="999">
      </div>
    </div>
  </div>

  {% if widget_mode == 'dtf' and show_3d_preview %}
    <!-- Optional 3D Preview Button (DTF mode with preview enabled) -->
    <div class="ul-section">
      <button class="ul-3d-preview-btn" id="ul-open-3d-{{ block.id }}" type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Preview on 3D T-Shirt</span>
      </button>
    </div>
  {% endif %}

  <!-- Hidden inputs for cart -->
  <input type="hidden" id="ul-upload-id-{{ block.id }}" name="properties[_upload_id]" value="">
  <input type="hidden" id="ul-file-url-{{ block.id }}" name="properties[_upload_file_url]" value="">
  <input type="hidden" id="ul-file-name-{{ block.id }}" name="properties[_upload_file_name]" value="">
  <input type="hidden" id="ul-position-{{ block.id }}" name="properties[_print_position]" value="front">
  <input type="hidden" id="ul-xpos-hidden-{{ block.id }}" name="properties[_print_x]" value="0">
  <input type="hidden" id="ul-ypos-hidden-{{ block.id }}" name="properties[_print_y]" value="0">
  <input type="hidden" id="ul-width-hidden-{{ block.id }}" name="properties[_design_width]" value="9">
  <input type="hidden" id="ul-height-hidden-{{ block.id }}" name="properties[_design_height]" value="9">
</div>

<!-- 3D Preview Modal -->
{% if show_3d_preview or widget_mode == 'tshirt' %}
  <div class="ul-modal" id="ul-modal-{{ block.id }}" style="display: none;">
    <div class="ul-modal-backdrop" id="ul-modal-close-{{ block.id }}"></div>
    <div class="ul-modal-content">
      <div class="ul-modal-header">
        <h3>Preview Your Design</h3>
        <button class="ul-modal-close-btn" id="ul-modal-x-{{ block.id }}" type="button">Ã—</button>
      </div>
      <div class="ul-modal-body">
        <div class="ul-3d-container" id="ul-3d-canvas-{{ block.id }}">
          <div class="ul-3d-loading">Loading 3D Model...</div>
        </div>
        <div class="ul-modal-controls">
          <!-- Position controls duplicated in modal -->
          <div class="ul-positions" style="margin-bottom: 16px;">
            <button class="ul-position-btn selected" data-position="front" type="button">
              <div class="ul-position-img">ðŸ‘•</div>
              <div class="ul-position-label">Front</div>
            </button>
            <button class="ul-position-btn" data-position="back" type="button">
              <div class="ul-position-img">ðŸ‘•</div>
              <div class="ul-position-label">Back</div>
            </button>
            <button class="ul-position-btn" data-position="left_sleeve" type="button">
              <div class="ul-position-img">ðŸ’ª</div>
              <div class="ul-position-label">Left</div>
            </button>
            <button class="ul-position-btn" data-position="right_sleeve" type="button">
              <div class="ul-position-img">ðŸ’ª</div>
              <div class="ul-position-label">Right</div>
            </button>
          </div>
          <div class="ul-slider-group">
            <div class="ul-slider-row">
              <span class="ul-slider-label">X Position</span>
              <input type="range" id="ul-modal-xpos-{{ block.id }}" min="-1" max="1" step="0.01" value="0">
              <span class="ul-slider-value">0</span>
            </div>
            <div class="ul-slider-row">
              <span class="ul-slider-label">Y Position</span>
              <input type="range" id="ul-modal-ypos-{{ block.id }}" min="-1" max="1" step="0.01" value="0">
              <span class="ul-slider-value">0</span>
            </div>
            <div class="ul-slider-row">
              <span class="ul-slider-label">Scale</span>
              <input type="range" id="ul-modal-scale-{{ block.id }}" min="0.1" max="2" step="0.05" value="1">
              <span class="ul-slider-value">100%</span>
            </div>
          </div>
        </div>
      </div>
      <div class="ul-modal-footer">
        <button class="ul-btn ul-btn-secondary" id="ul-modal-cancel-{{ block.id }}" type="button">Cancel</button>
        <button class="ul-btn ul-btn-primary" id="ul-modal-apply-{{ block.id }}" type="button">Apply & Continue</button>
      </div>
    </div>
  </div>

  <style>
    .ul-modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ul-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
    }

    .ul-modal-content {
      position: relative;
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .ul-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--ul-border);
    }

    .ul-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .ul-modal-close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--ul-text-muted);
    }

    .ul-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .ul-3d-container {
      width: 100%;
      height: 350px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
      border-radius: var(--ul-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .ul-3d-loading {
      color: var(--ul-text-muted);
    }

    .ul-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--ul-border);
    }

    .ul-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .ul-btn-secondary {
      background: white;
      border: 1px solid var(--ul-border);
      color: var(--ul-text);
    }

    .ul-btn-secondary:hover {
      background: #f9fafb;
    }

    .ul-btn-primary {
      background: var(--ul-primary);
      border: none;
      color: white;
    }

    .ul-btn-primary:hover {
      background: var(--ul-primary-hover);
    }
  </style>
{% endif %}

<script src="{{ 'upload-widget.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Upload Widget",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "select",
      "id": "mode",
      "label": "Widget Mode",
      "options": [
        { "value": "dtf", "label": "DTF Transfer (Simple Upload)" },
        { "value": "tshirt", "label": "T-Shirt (Full 3D Designer)" }
      ],
      "default": "dtf"
    },
    {
      "type": "checkbox",
      "id": "show_3d_preview",
      "label": "Enable 3D T-Shirt Preview",
      "info": "Show optional 3D preview button in DTF mode",
      "default": false
    },
    {
      "type": "select",
      "id": "preview_display",
      "label": "3D Preview Display",
      "options": [
        { "value": "inline", "label": "Inline (on page)" },
        { "value": "popup", "label": "Popup (modal)" }
      ],
      "default": "popup"
    },
    {
      "type": "text",
      "id": "upload_label",
      "label": "Upload Section Label",
      "default": "Upload Your Design"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#6366f1"
    },
    {
      "type": "range",
      "id": "max_file_size_mb",
      "label": "Max File Size (MB)",
      "min": 5,
      "max": 100,
      "step": 5,
      "default": 25
    }
  ]
}
{% endschema %}
