{% comment %}
  Custom Upload for Products Design - Unified Product Customizer
  Supports: DTF Only Mode + 3D T-Shirt Mode
  
  Features:
  - Upload design
  - Size selection from Shopify variants
  - "T-Shirt Dahil" toggle for 3D mode (Pro+ only)
  - 4 mini 3D position previews
  - Multi-location print support
  - Real-time price calculation
  - Coordinate adjustment sliders
{% endcomment %}

{% liquid
  assign product_id = product.id
  assign variant_id = product.selected_or_first_available_variant.id
  assign product_handle = product.handle
  
  comment
    Get upload config from product metafield
  endcomment
  assign upload_config = product.metafields.custom_upload.config.value
  
  if upload_config != blank
    assign upload_enabled = upload_config.enabled | default: false
    assign upload_mode = upload_config.mode | default: 'classic'
    assign asset_set_id = upload_config.assetSetId | default: ''
    assign max_size_mb = upload_config.maxSizeMB | default: 25
    assign tshirt_product_id = upload_config.tshirtProductId | default: ''
    assign print_locations = upload_config.printLocations | default: 'front,back'
    assign pricing_per_location = upload_config.pricingPerLocation | default: nil
  else
    assign upload_enabled = false
    assign upload_mode = 'classic'
    assign asset_set_id = ''
    assign max_size_mb = 25
    assign tshirt_product_id = ''
    assign print_locations = 'front,back'
  endif
  
  comment
    Get shop plan from metafield
  endcomment
  assign shop_plan = shop.metafields.custom_upload.plan.value | default: 'free'
  assign tshirt_mode_enabled = false
  
  if shop_plan == 'pro' or shop_plan == 'enterprise'
    if upload_mode == '3d_designer'
      assign tshirt_mode_enabled = true
    endif
  endif
  
  comment
    Get app URL
  endcomment
  assign app_url = shop.metafields.custom_upload.app_url.value | default: 'https://customizerapp.dev'
  
  comment
    Parse allowed print locations
  endcomment
  assign locations_array = print_locations | split: ','
  
  comment
    Debug mode
  endcomment
  assign debug_mode = false
%}

{% assign should_show = false %}
{% if debug_mode %}
  {% assign should_show = true %}
{% elsif upload_enabled %}
  {% assign should_show = true %}
{% endif %}

{% if should_show %}
<div
  id="custom-upload-widget"
  class="cu-widget"
  data-product-id="{{ product_id }}"
  data-product-handle="{{ product_handle }}"
  data-variant-id="{{ variant_id }}"
  data-mode="{{ upload_mode }}"
  data-asset-set-id="{{ asset_set_id }}"
  data-max-size="{{ max_size_mb }}"
  data-app-url="{{ app_url }}"
  data-shop-domain="{{ shop.permanent_domain }}"
  data-tshirt-enabled="{{ tshirt_mode_enabled }}"
  data-tshirt-product-id="{{ tshirt_product_id }}"
  data-print-locations="{{ print_locations }}"
  data-shop-plan="{{ shop_plan }}"
  data-product-price="{{ product.price | money_without_currency }}"
  data-debug="{{ debug_mode }}"
>
  <!-- Main Container Grid -->
  <div class="cu-main-grid">
    
    <!-- LEFT SIDE: Gallery / 3D Canvas -->
    <div class="cu-left-section">
      <!-- Normal Product Gallery (DTF Mode) -->
      <div id="cu-gallery-section" class="cu-gallery-section">
        <div class="cu-main-image">
          <img 
            id="cu-product-image" 
            src="{{ product.featured_image | image_url: width: 800 }}" 
            alt="{{ product.title }}"
            width="800"
            height="800"
          >
        </div>
        {% if product.images.size > 1 %}
        <div class="cu-thumbnails">
          {% for image in product.images limit: 5 %}
          <button 
            type="button" 
            class="cu-thumb-btn {% if forloop.first %}active{% endif %}"
            data-image-url="{{ image | image_url: width: 800 }}"
          >
            <img src="{{ image | image_url: width: 100 }}" alt="{{ product.title }}" width="100" height="100">
          </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      
      <!-- 3D Canvas Section (Hidden by default, shown in T-Shirt mode) -->
      <div id="cu-3d-section" class="cu-3d-section" style="display: none;">
        <div class="cu-3d-canvas-wrapper">
          <canvas id="cu-3d-canvas" class="cu-3d-canvas"></canvas>
          
          <!-- Loading Overlay -->
          <div id="cu-3d-loading" class="cu-3d-loading">
            <div class="cu-spinner"></div>
            <p>Loading 3D Model...</p>
          </div>
          
          <!-- Camera Controls -->
          <div class="cu-camera-controls">
            <button type="button" class="cu-cam-btn" data-action="rotate-left" title="Rotate Left">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/>
              </svg>
            </button>
            <button type="button" class="cu-cam-btn" data-action="reset" title="Reset View">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
              </svg>
            </button>
            <button type="button" class="cu-cam-btn" data-action="rotate-right" title="Rotate Right">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Live Coordinates Display -->
        <div class="cu-coordinates">
          <span>X: <strong id="cu-coord-x">0.00</strong></span>
          <span>Y: <strong id="cu-coord-y">0.00</strong></span>
          <span>Z: <strong id="cu-coord-z">0.00</strong></span>
        </div>
      </div>
    </div>
    
    <!-- RIGHT SIDE: Options Panel -->
    <div class="cu-right-section">
      <!-- Product Info -->
      <div class="cu-product-info">
        <h1 class="cu-product-title">{{ product.title }}</h1>
        {% if product.metafields.reviews.rating %}
        <div class="cu-rating">
          ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ <span>({{ product.metafields.reviews.rating_count | default: 0 }} reviews)</span>
        </div>
        {% endif %}
        <div class="cu-price-display">
          <span id="cu-total-price" class="cu-price">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
          <span class="cu-compare-price">{{ product.compare_at_price | money }}</span>
          {% endif %}
        </div>
      </div>
      
      <!-- Step 1: Upload Design -->
      <div class="cu-step" data-step="1">
        <div class="cu-step-header">
          <span class="cu-step-number">1</span>
          <span class="cu-step-title">{{ 'custom_upload.upload_design' | t | default: 'Upload Your Design' }}</span>
          <span id="cu-upload-status" class="cu-step-status"></span>
        </div>
        <div class="cu-step-content">
          <div id="cu-upload-area" class="cu-upload-area">
            <input type="file" id="cu-file-input" accept="image/*,.pdf,.ai,.eps,.svg" class="cu-file-input">
            <div class="cu-upload-content">
              <svg class="cu-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17,8 12,3 7,8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="cu-upload-text">{{ 'custom_upload.drag_drop' | t | default: 'Drag your design here' }}</p>
              <p class="cu-upload-subtext">{{ 'custom_upload.or_browse' | t | default: 'or click to browse' }} (PNG, JPG, PDF - Max {{ max_size_mb }}MB)</p>
            </div>
          </div>
          
          <!-- Upload Preview (hidden initially) -->
          <div id="cu-upload-preview" class="cu-upload-preview" style="display: none;">
            <img id="cu-preview-img" src="" alt="Design Preview" width="80" height="80">
            <div class="cu-preview-info">
              <span id="cu-preview-name">design.png</span>
              <div class="cu-preview-actions">
                <button type="button" id="cu-change-file" class="cu-btn-small">Change</button>
                <button type="button" id="cu-remove-file" class="cu-btn-small cu-btn-danger">Remove</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Step 2: Select Size (DTF Mode) / Hidden in T-Shirt Mode -->
      <div id="cu-size-step" class="cu-step" data-step="2">
        <div class="cu-step-header">
          <span class="cu-step-number">2</span>
          <span class="cu-step-title">{{ 'custom_upload.select_size' | t | default: 'Select Size' }}</span>
        </div>
        <div class="cu-step-content">
          <div class="cu-size-options">
            {% for variant in product.variants %}
            <button 
              type="button" 
              class="cu-size-btn {% if variant.id == variant_id %}active{% endif %}"
              data-variant-id="{{ variant.id }}"
              data-price="{{ variant.price | money_without_currency }}"
              {% unless variant.available %}disabled{% endunless %}
            >
              {{ variant.title }}
              {% unless variant.available %}<span class="cu-sold-out">Sold Out</span>{% endunless %}
            </button>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <!-- T-Shirt Toggle Button (Only shown if tshirt_mode_enabled) -->
      {% if tshirt_mode_enabled %}
      <div class="cu-tshirt-toggle-section">
        <button type="button" id="cu-tshirt-toggle" class="cu-tshirt-toggle">
          <span class="cu-toggle-icon">üëï</span>
          <span class="cu-toggle-text">{{ 'custom_upload.include_tshirt' | t | default: 'T-Shirt Dahil Olsun' }}</span>
          <span class="cu-toggle-price">+ {{ shop.metafields.custom_upload.tshirt_base_price.value | default: '$15.00' }}</span>
        </button>
      </div>
      {% endif %}
      
      <!-- Step 3: Print Position (3D Mode Only) -->
      <div id="cu-position-step" class="cu-step" data-step="3" style="display: none;">
        <div class="cu-step-header">
          <span class="cu-step-number">2</span>
          <span class="cu-step-title">{{ 'custom_upload.select_position' | t | default: 'Select Print Position' }}</span>
        </div>
        <div class="cu-step-content">
          <!-- 4 Mini 3D Previews -->
          <div class="cu-position-grid">
            {% for loc in locations_array %}
            {% assign loc_clean = loc | strip %}
            <div class="cu-position-item" data-position="{{ loc_clean }}">
              <canvas 
                id="cu-mini-{{ loc_clean }}" 
                class="cu-mini-canvas"
                width="120"
                height="120"
              ></canvas>
              <div class="cu-position-label">
                {% case loc_clean %}
                  {% when 'front' %}
                    {{ 'custom_upload.front' | t | default: 'Front' }}
                  {% when 'back' %}
                    {{ 'custom_upload.back' | t | default: 'Back' }}
                  {% when 'left_sleeve' %}
                    {{ 'custom_upload.left_sleeve' | t | default: 'Left Sleeve' }}
                  {% when 'right_sleeve' %}
                    {{ 'custom_upload.right_sleeve' | t | default: 'Right Sleeve' }}
                  {% else %}
                    {{ loc_clean | capitalize }}
                {% endcase %}
              </div>
              <span class="cu-position-check" style="display: none;">‚úì</span>
            </div>
            {% endfor %}
          </div>
          
          <!-- Selected Locations List -->
          <div id="cu-selected-locations" class="cu-selected-locations"></div>
          
          <button type="button" id="cu-add-location" class="cu-add-location-btn">
            + {{ 'custom_upload.add_location' | t | default: 'Add Another Location' }}
          </button>
        </div>
      </div>
      
      <!-- Step 4: Adjust Position (3D Mode Only) -->
      <div id="cu-adjust-step" class="cu-step" data-step="4" style="display: none;">
        <div class="cu-step-header">
          <span class="cu-step-number">3</span>
          <span class="cu-step-title">{{ 'custom_upload.adjust_position' | t | default: 'Adjust Position' }}</span>
        </div>
        <div class="cu-step-content">
          <!-- Info Banner -->
          <div class="cu-info-banner">
            <span class="cu-info-icon">‚ÑπÔ∏è</span>
            <span>{{ 'custom_upload.position_help' | t | default: "Don't worry! If you can't position perfectly, our team will optimize it for you." }}</span>
          </div>
          
          <div class="cu-slider-group">
            <label>X Position</label>
            <div class="cu-slider-row">
              <input type="range" id="cu-pos-x" class="cu-slider" min="-100" max="100" value="0">
              <span id="cu-pos-x-val" class="cu-slider-val">0</span>
            </div>
          </div>
          
          <div class="cu-slider-group">
            <label>Y Position</label>
            <div class="cu-slider-row">
              <input type="range" id="cu-pos-y" class="cu-slider" min="-100" max="100" value="0">
              <span id="cu-pos-y-val" class="cu-slider-val">0</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Step 5: Set Design Size (3D Mode Only) -->
      <div id="cu-size-adjust-step" class="cu-step" data-step="5" style="display: none;">
        <div class="cu-step-header">
          <span class="cu-step-number">4</span>
          <span class="cu-step-title">{{ 'custom_upload.set_size' | t | default: 'Set Design Size' }}</span>
        </div>
        <div class="cu-step-content">
          <div class="cu-size-sliders">
            <div class="cu-slider-group">
              <label>Width (inch)</label>
              <div class="cu-slider-row">
                <input type="range" id="cu-width" class="cu-slider" min="1" max="14" value="8" step="0.5">
                <span id="cu-width-val" class="cu-slider-val">8"</span>
              </div>
            </div>
            
            <div class="cu-slider-group">
              <label>Height (inch)</label>
              <div class="cu-slider-row">
                <input type="range" id="cu-height" class="cu-slider" min="1" max="16" value="10" step="0.5">
                <span id="cu-height-val" class="cu-slider-val">10"</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- T-Shirt Options (3D Mode Only) -->
      <div id="cu-tshirt-options" class="cu-step" style="display: none;">
        <div class="cu-step-header">
          <span class="cu-step-number">5</span>
          <span class="cu-step-title">{{ 'custom_upload.tshirt_options' | t | default: 'T-Shirt Options' }}</span>
        </div>
        <div class="cu-step-content">
          <!-- T-Shirt Size -->
          <div class="cu-option-group">
            <label>Size</label>
            <div id="cu-tshirt-sizes" class="cu-size-options">
              <!-- Will be populated dynamically from tshirt product variants -->
            </div>
          </div>
          
          <!-- T-Shirt Color -->
          <div class="cu-option-group">
            <label>Color</label>
            <div id="cu-tshirt-colors" class="cu-color-options">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Price Breakdown -->
      <div id="cu-price-breakdown" class="cu-price-breakdown" style="display: none;">
        <div class="cu-price-line">
          <span>DTF Sheet Base</span>
          <span id="cu-price-dtf">$0.00</span>
        </div>
        <div class="cu-price-line cu-price-tshirt" style="display: none;">
          <span>T-Shirt (<span id="cu-tshirt-size-display">M</span>)</span>
          <span id="cu-price-tshirt-val">$15.00</span>
        </div>
        <div id="cu-price-locations" class="cu-price-locations">
          <!-- Dynamic location prices -->
        </div>
        <div class="cu-price-total">
          <span>Total</span>
          <span id="cu-final-price">$0.00</span>
        </div>
      </div>
      
      <!-- Quantity -->
      <div class="cu-quantity-section">
        <label>Quantity</label>
        <div class="cu-quantity-input">
          <button type="button" id="cu-qty-minus" class="cu-qty-btn">‚àí</button>
          <input type="number" id="cu-quantity" value="1" min="1" max="999">
          <button type="button" id="cu-qty-plus" class="cu-qty-btn">+</button>
        </div>
      </div>
      
      <!-- Add to Cart -->
      <div class="cu-cart-section">
        <button type="button" id="cu-add-to-cart" class="cu-add-to-cart" disabled>
          <span class="cu-cart-text">{{ 'custom_upload.add_to_cart' | t | default: 'Add to Cart' }}</span>
          <span class="cu-cart-price" id="cu-cart-price">{{ product.price | money }}</span>
        </button>
      </div>
      
      <!-- Hidden Form Fields -->
      <input type="hidden" id="cu-upload-id" name="properties[_custom_upload_id]" value="">
      <input type="hidden" id="cu-upload-mode" name="properties[_custom_upload_mode]" value="dtf_only">
      <input type="hidden" id="cu-upload-preview-url" name="properties[_custom_upload_preview]" value="">
      <input type="hidden" id="cu-print-locations-data" name="properties[_print_locations]" value="">
      <input type="hidden" id="cu-tshirt-included" name="properties[_tshirt_included]" value="false">
    </div>
  </div>
</div>

<!-- Styles -->
<style>
:root {
  --cu-primary: #7367f0;
  --cu-primary-hover: #5e50ee;
  --cu-primary-light: rgba(115, 103, 240, 0.1);
  --cu-success: #28c76f;
  --cu-warning: #ff9f43;
  --cu-danger: #ea5455;
  --cu-border: #ebe9f1;
  --cu-bg: #f8f8f8;
  --cu-text: #5e5873;
  --cu-text-muted: #b9b9c3;
  --cu-radius: 12px;
  --cu-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
}

.cu-widget {
  font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--cu-text);
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.cu-main-grid {
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 40px;
}

@media (max-width: 1024px) {
  .cu-main-grid {
    grid-template-columns: 1fr;
  }
}

/* Left Section - Gallery / 3D */
.cu-left-section {
  position: sticky;
  top: 20px;
  height: fit-content;
}

.cu-gallery-section .cu-main-image {
  background: #fff;
  border-radius: var(--cu-radius);
  overflow: hidden;
  box-shadow: var(--cu-shadow);
}

.cu-gallery-section .cu-main-image img {
  width: 100%;
  height: auto;
  display: block;
}

.cu-thumbnails {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.cu-thumb-btn {
  width: 80px;
  height: 80px;
  border: 2px solid var(--cu-border);
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  padding: 0;
  background: #fff;
  transition: border-color 0.2s;
}

.cu-thumb-btn:hover,
.cu-thumb-btn.active {
  border-color: var(--cu-primary);
}

.cu-thumb-btn img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 3D Section */
.cu-3d-section {
  background: #fff;
  border-radius: var(--cu-radius);
  overflow: hidden;
  box-shadow: var(--cu-shadow);
}

.cu-3d-canvas-wrapper {
  position: relative;
  aspect-ratio: 1;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.cu-3d-canvas {
  width: 100%;
  height: 100%;
  display: block;
}

.cu-3d-loading {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.95);
  color: var(--cu-text);
}

.cu-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--cu-border);
  border-top-color: var(--cu-primary);
  border-radius: 50%;
  animation: cu-spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes cu-spin {
  to { transform: rotate(360deg); }
}

.cu-camera-controls {
  position: absolute;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 16px;
  border-radius: 30px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.cu-cam-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: transparent;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--cu-text);
  transition: all 0.2s;
}

.cu-cam-btn:hover {
  background: var(--cu-primary-light);
  color: var(--cu-primary);
}

.cu-coordinates {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 12px;
  background: #1a1a2e;
  color: #fff;
  font-size: 13px;
  font-family: monospace;
}

.cu-coordinates strong {
  color: var(--cu-success);
}

/* Right Section */
.cu-right-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.cu-product-info {
  padding-bottom: 20px;
  border-bottom: 1px solid var(--cu-border);
}

.cu-product-title {
  font-size: 24px;
  font-weight: 600;
  margin: 0 0 8px;
  color: var(--cu-text);
}

.cu-rating {
  font-size: 14px;
  color: #ffc107;
  margin-bottom: 10px;
}

.cu-rating span {
  color: var(--cu-text-muted);
  margin-left: 5px;
}

.cu-price-display {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cu-price {
  font-size: 28px;
  font-weight: 700;
  color: var(--cu-primary);
}

.cu-compare-price {
  font-size: 18px;
  color: var(--cu-text-muted);
  text-decoration: line-through;
}

/* Steps */
.cu-step {
  background: #fff;
  border-radius: var(--cu-radius);
  padding: 20px;
  box-shadow: var(--cu-shadow);
}

.cu-step-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.cu-step-number {
  width: 28px;
  height: 28px;
  background: var(--cu-primary);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
}

.cu-step-title {
  font-size: 16px;
  font-weight: 600;
}

.cu-step-status {
  margin-left: auto;
  font-size: 13px;
}

.cu-step-status.success {
  color: var(--cu-success);
}

/* Upload Area */
.cu-upload-area {
  border: 2px dashed var(--cu-border);
  border-radius: var(--cu-radius);
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  position: relative;
  transition: all 0.3s;
}

.cu-upload-area:hover,
.cu-upload-area.dragover {
  border-color: var(--cu-primary);
  background: var(--cu-primary-light);
}

.cu-file-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.cu-upload-icon {
  color: var(--cu-text-muted);
  margin-bottom: 15px;
}

.cu-upload-text {
  font-size: 16px;
  font-weight: 500;
  margin: 0 0 5px;
}

.cu-upload-subtext {
  font-size: 13px;
  color: var(--cu-text-muted);
  margin: 0;
}

.cu-upload-preview {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: var(--cu-primary-light);
  border-radius: var(--cu-radius);
}

.cu-upload-preview img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  border-radius: 8px;
  background: #fff;
}

.cu-preview-info {
  flex: 1;
}

.cu-preview-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.cu-btn-small {
  padding: 6px 12px;
  font-size: 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #fff;
  color: var(--cu-text);
  transition: all 0.2s;
}

.cu-btn-small:hover {
  background: var(--cu-primary);
  color: #fff;
}

.cu-btn-danger:hover {
  background: var(--cu-danger);
}

/* Size Options */
.cu-size-options {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.cu-size-btn {
  padding: 12px 20px;
  border: 2px solid var(--cu-border);
  border-radius: 8px;
  background: #fff;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.cu-size-btn:hover {
  border-color: var(--cu-primary);
}

.cu-size-btn.active {
  border-color: var(--cu-primary);
  background: var(--cu-primary);
  color: #fff;
}

.cu-size-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.cu-sold-out {
  font-size: 10px;
  display: block;
  color: var(--cu-danger);
}

/* T-Shirt Toggle */
.cu-tshirt-toggle-section {
  margin: 10px 0;
}

.cu-tshirt-toggle {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  background: linear-gradient(135deg, var(--cu-primary) 0%, #9c27b0 100%);
  color: #fff;
  border: none;
  border-radius: var(--cu-radius);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(115, 103, 240, 0.4);
}

.cu-tshirt-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(115, 103, 240, 0.5);
}

.cu-tshirt-toggle.active {
  background: linear-gradient(135deg, #28c76f 0%, #48d483 100%);
  box-shadow: 0 4px 15px rgba(40, 199, 111, 0.4);
}

.cu-toggle-icon {
  font-size: 24px;
}

.cu-toggle-text {
  flex: 1;
  text-align: left;
}

.cu-toggle-price {
  background: rgba(255, 255, 255, 0.2);
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 13px;
}

/* Position Grid */
.cu-position-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

.cu-position-item {
  position: relative;
  background: var(--cu-bg);
  border: 2px solid var(--cu-border);
  border-radius: 10px;
  padding: 10px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.cu-position-item:hover {
  border-color: var(--cu-primary);
}

.cu-position-item.active {
  border-color: var(--cu-primary);
  background: var(--cu-primary-light);
}

.cu-position-item.selected {
  border-color: var(--cu-success);
}

.cu-mini-canvas {
  width: 100%;
  aspect-ratio: 1;
  background: #fff;
  border-radius: 8px;
}

.cu-position-label {
  font-size: 12px;
  font-weight: 500;
  margin-top: 8px;
}

.cu-position-check {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 20px;
  height: 20px;
  background: var(--cu-success);
  color: #fff;
  border-radius: 50%;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Selected Locations */
.cu-selected-locations {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.cu-location-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 15px;
  background: var(--cu-bg);
  border-radius: 8px;
  font-size: 14px;
}

.cu-location-item .cu-location-name {
  display: flex;
  align-items: center;
  gap: 8px;
}

.cu-location-item .cu-location-price {
  font-weight: 600;
  color: var(--cu-primary);
}

.cu-location-item .cu-remove-location {
  background: none;
  border: none;
  color: var(--cu-danger);
  cursor: pointer;
  font-size: 18px;
}

.cu-add-location-btn {
  width: 100%;
  padding: 12px;
  border: 2px dashed var(--cu-border);
  border-radius: 8px;
  background: transparent;
  color: var(--cu-primary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  margin-top: 10px;
  transition: all 0.2s;
}

.cu-add-location-btn:hover {
  border-color: var(--cu-primary);
  background: var(--cu-primary-light);
}

/* Sliders */
.cu-slider-group {
  margin-bottom: 15px;
}

.cu-slider-group label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 8px;
  color: var(--cu-text-muted);
}

.cu-slider-row {
  display: flex;
  align-items: center;
  gap: 15px;
}

.cu-slider {
  flex: 1;
  height: 6px;
  -webkit-appearance: none;
  background: var(--cu-border);
  border-radius: 3px;
  outline: none;
}

.cu-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  background: var(--cu-primary);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(115, 103, 240, 0.4);
}

.cu-slider-val {
  min-width: 40px;
  text-align: right;
  font-weight: 600;
  color: var(--cu-primary);
}

/* Info Banner */
.cu-info-banner {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 12px 15px;
  background: rgba(40, 199, 111, 0.1);
  border-radius: 8px;
  font-size: 13px;
  color: var(--cu-success);
  margin-bottom: 15px;
}

.cu-info-icon {
  flex-shrink: 0;
}

/* Color Options */
.cu-color-options {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.cu-color-btn {
  width: 40px;
  height: 40px;
  border: 3px solid transparent;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.cu-color-btn:hover {
  transform: scale(1.1);
}

.cu-color-btn.active {
  border-color: var(--cu-primary);
  transform: scale(1.1);
}

/* Price Breakdown */
.cu-price-breakdown {
  background: var(--cu-bg);
  border-radius: var(--cu-radius);
  padding: 20px;
}

.cu-price-line {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  padding: 8px 0;
  border-bottom: 1px solid var(--cu-border);
}

.cu-price-total {
  display: flex;
  justify-content: space-between;
  font-size: 18px;
  font-weight: 700;
  padding-top: 12px;
  color: var(--cu-text);
}

.cu-price-total span:last-child {
  color: var(--cu-primary);
}

/* Quantity */
.cu-quantity-section {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.cu-quantity-section label {
  font-weight: 500;
}

.cu-quantity-input {
  display: flex;
  align-items: center;
  gap: 0;
  border: 2px solid var(--cu-border);
  border-radius: 8px;
  overflow: hidden;
}

.cu-qty-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: var(--cu-bg);
  font-size: 18px;
  cursor: pointer;
  transition: background 0.2s;
}

.cu-qty-btn:hover {
  background: var(--cu-primary-light);
}

.cu-quantity-input input {
  width: 50px;
  height: 40px;
  border: none;
  text-align: center;
  font-size: 16px;
  font-weight: 600;
}

/* Add to Cart */
.cu-cart-section {
  margin-top: 10px;
}

.cu-add-to-cart {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, var(--cu-primary) 0%, #9c27b0 100%);
  color: #fff;
  border: none;
  border-radius: var(--cu-radius);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(115, 103, 240, 0.4);
}

.cu-add-to-cart:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(115, 103, 240, 0.5);
}

.cu-add-to-cart:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.cu-cart-price {
  background: rgba(255, 255, 255, 0.2);
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 15px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .cu-main-grid {
    gap: 20px;
  }
  
  .cu-left-section {
    position: static;
  }
  
  .cu-position-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .cu-product-title {
    font-size: 20px;
  }
  
  .cu-price {
    font-size: 24px;
  }
}
</style>

<!-- Three.js Scripts (Loaded with defer, polling pattern handles timing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/DecalGeometry.js" defer></script>

<!-- Main Widget Script -->
<script src="{{ 'custom-upload-main.js' | asset_url }}" defer></script>

<!-- 3D Module (loaded when needed) -->
<script src="{{ 'custom-upload-3d.js' | asset_url }}" defer></script>

{% endif %}

{% schema %}
{
  "name": "Custom Upload Widget",
  "target": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Widget Settings"
    },
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Reviews",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_price_breakdown",
      "label": "Show Price Breakdown",
      "default": true
    }
  ]
}
{% endschema %}
