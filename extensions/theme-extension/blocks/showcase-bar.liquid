{% comment %}
  Product Showcase Bar - Collection Based
  Merchant selects a collection, products from that collection are displayed in grid
{% endcomment %}

{{ 'ul-showcase.css' | asset_url | stylesheet_tag }}

{% comment %} Mobile ordering - showcase bar comes after DTF block {% endcomment %}
<style>
  @media (max-width: 749px) {
    .ul-showcase-section {
      order: 5 !important;
    }
  }
</style>

{% comment %} Check if we're in theme editor {% endcomment %}
{% assign is_design_mode = false %}
{% if request.design_mode %}
  {% assign is_design_mode = true %}
{% endif %}

<div class="ul-showcase-section" data-block-id="{{ block.id }}" data-design-mode="{{ is_design_mode }}" style="background:{{ block.settings.bg_color | default: '#f8f9fa' }};padding:40px 20px;">
  {% if block.settings.show_header %}
  <div class="ul-showcase-header">
    <div class="ul-header-deco"><span class="ul-sh-deco-line"></span><div class="ul-header-box"><span class="ul-sh-header-tag">{{ block.settings.header_tag | default: 'SPECIAL OFFERS' }}</span></div><span class="ul-sh-deco-line"></span></div>
    <p class="ul-sh-header-subtitle">{{ block.settings.header_subtitle | default: 'Handpicked products just for you' }}</p>
  </div>
  {% endif %}

  <div class="ul-showcase-grid">
    {% assign max_products = block.settings.max_products | default: 5 %}
    {% assign collection = block.settings.collection %}

    {% if collection and collection.products.size > 0 %}
      {% for p in collection.products limit: max_products %}
      <div class="ul-showcase-card" data-product-id="{{ p.id }}" data-variant-id="{{ p.selected_or_first_available_variant.id }}" data-product-title="{{ p.title | escape }}" data-product-price="{{ p.price | money }}" data-product-image="{{ p.featured_image | image_url: width: 350 }}">
        <div class="ul-sh-badges">
          <span class="ul-sh-badge-4d">4D</span>
          {% if p.compare_at_price > p.price %}{% assign disc = p.compare_at_price | minus: p.price | times: 100 | divided_by: p.compare_at_price %}<span class="ul-sh-badge-sale">-{{ disc }}%</span>{% endif %}
        </div>
        <button class="ul-sh-wishlist" type="button"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
        <a href="{{ p.url }}" class="ul-sh-image-wrap"><img src="{{ p.featured_image | image_url: width: 350 }}" alt="{{ p.title }}" width="350" height="350" loading="lazy"></a>
        <div class="ul-sh-content">
          <span class="ul-sh-vendor">{{ p.vendor | default: 'DTF TRANSFER' }}</span>
          <h3 class="ul-sh-title"><a href="{{ p.url }}">{{ p.title | truncate: 40 }}</a></h3>
          {% if block.settings.show_reviews %}<div class="ul-sh-rating"><span class="ul-sh-stars">★★★★★</span><span class="ul-sh-count">({{ p.id | modulo: 200 | plus: 50 }})</span></div>{% endif %}
          <div class="ul-sh-price">{% if p.compare_at_price > p.price %}<span class="ul-sh-old">{{ p.compare_at_price | money }}</span>{% endif %}<span class="ul-sh-now">{{ p.price | money }}</span></div>
          <button class="ul-sh-upload-btn" type="button" {% unless is_design_mode %}onclick="openULShowcaseModal(this)"{% endunless %}><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload Design</button>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p style="grid-column:1/-1;text-align:center;padding:40px;color:#888;">Select a collection in block settings</p>
    {% endif %}
  </div>
</div>

<div class="ul-sh-modal-overlay" id="ulShowcaseModal-{{ block.id }}">
  <div class="ul-sh-modal">
    <div class="ul-sh-modal-header"><h3>Upload Your Design</h3><button class="ul-sh-modal-close" onclick="closeULShowcaseModal('{{ block.id }}')">×</button></div>
    <div class="ul-sh-modal-body">
      <div class="ul-sh-modal-product"><img id="ulShowcaseImg-{{ block.id }}" src="" alt="" width="55" height="55"><div><strong id="ulShowcaseTitle-{{ block.id }}"></strong><span id="ulShowcasePrice-{{ block.id }}"></span></div></div>
      <div class="ul-sh-upload-zone" id="ulShowcaseZone-{{ block.id }}" onclick="document.getElementById('ulShowcaseFile-{{ block.id }}').click()">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#7367f0" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <p><strong>Drag & drop your design here</strong></p>
        <span style="font-size:12px;color:#9ca3af;">or click to browse • PNG, JPG, WEBP, TIFF, PSD, PDF, AI, EPS • Max 10GB</span>
        <input type="file" id="ulShowcaseFile-{{ block.id }}" accept=".png,.jpg,.jpeg,.webp,.tiff,.tif,.psd,.svg,.pdf,.ai,.eps" style="display:none" onchange="handleULShowcaseFile(event,'{{ block.id }}')">
      </div>
      <div class="ul-sh-preview-zone" id="ulShowcasePreview-{{ block.id }}" style="display:none">
        <img id="ulShowcasePreviewImg-{{ block.id }}" src="" alt="" width="200" height="200"><button class="ul-sh-remove-btn" onclick="removeULShowcaseFile('{{ block.id }}')">×</button>
      </div>
      <div class="ul-sh-size-section"><label>Sheet Size:</label>
        <select class="ul-sh-size-select" id="ulShowcaseSize-{{ block.id }}" onchange="selectULShowcaseSize(this,'{{ block.id }}')">
          <option value="22x6" data-price="7.50">22" x 6" - $7.50</option>
          <option value="22x12" data-price="12.00" selected>22" x 12" - $12.00</option>
          <option value="22x24" data-price="22.00">22" x 24" - $22.00</option>
          <option value="22x60" data-price="50.00">22" x 60" - $50.00</option>
        </select>
      </div>
      <div class="ul-sh-qty-row"><span>Quantity:</span><div class="ul-sh-qty-controls"><button onclick="changeULShowcaseQty('{{ block.id }}',-1)">−</button><input type="number" id="ulShowcaseQty-{{ block.id }}" value="1" min="1"><button onclick="changeULShowcaseQty('{{ block.id }}',1)">+</button></div></div>
    </div>
    <div class="ul-sh-modal-footer"><button class="ul-sh-cart-btn" id="ulShowcaseCartBtn-{{ block.id }}" onclick="addULShowcaseToCart('{{ block.id }}')" disabled>Upload design to continue</button></div>
  </div>
</div>

<script src="{{ 'ul-showcase.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Product Showcase Bar",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_header",
      "label": "Show Header",
      "default": true
    },
    {
      "type": "text",
      "id": "header_tag",
      "label": "Header Tag",
      "default": "SPECIAL OFFERS"
    },
    {
      "type": "text",
      "id": "header_subtitle",
      "label": "Subtitle",
      "default": "Handpicked products just for you"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Product Collection"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 5,
      "label": "Max Products to Show"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#f8f9fa"
    },
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Star Ratings",
      "default": true
    }
  ]
}
{% endschema %}
