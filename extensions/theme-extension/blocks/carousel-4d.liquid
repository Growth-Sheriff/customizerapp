{% comment %}
  3D Carousel 4D - App Block
  Collection-based carousel with upload button
{% endcomment %}

<div class="ul-carousel-widget" data-section-id="{{ section.id }}">
  <!-- Banner (optional) -->
  {% if block.settings.show_banner %}
  <div class="ul-banner-box">
    <span class="ul-banner-badge">ðŸ”¥ {{ block.settings.banner_badge | default: 'LIMITED TIME' }}</span>
    <h2 class="ul-banner-title">{{ block.settings.banner_title | default: 'BLACK FRIDAY' }}</h2>
    <p class="ul-banner-text">{{ block.settings.banner_text | default: 'Exclusive deals on premium products' }}</p>
  </div>
  {% endif %}

  <!-- Products Carousel from Collection -->
  <div class="ul-carousel-container">
    <div class="ul-carousel-track" id="ulCarouselTrack-{{ block.id }}">
      {% assign coll = block.settings.collection %}
      {% assign limit = block.settings.products_count | default: 6 %}
      {% for product in coll.products limit: limit %}
        <div class="ul-carousel-card" 
             data-product-id="{{ product.id }}"
             data-variant-id="{{ product.selected_or_first_available_variant.id }}"
             data-product-title="{{ product.title | escape }}"
             data-product-price="{{ product.price | money }}"
             data-product-image="{{ product.featured_image | image_url: width: 400 }}">
          
          <!-- 4D Badge -->
          <span class="ul-4d-badge">4D</span>
          
          <!-- Wishlist -->
          <button class="ul-wishlist-btn" type="button" aria-label="Wishlist">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          </button>
          
          <!-- Product Image -->
          <div class="ul-card-image">
            <a href="{{ product.url }}">
              <img src="{{ product.featured_image | image_url: width: 400 }}" 
                   alt="{{ product.title }}" 
                   loading="lazy"
                   width="400"
                   height="400">
            </a>
          </div>
          
          <!-- Product Info -->
          <div class="ul-card-info">
            <span class="ul-card-vendor">{{ product.vendor | default: 'DTF TRANSFER' }}</span>
            <h3 class="ul-card-title"><a href="{{ product.url }}">{{ product.title }}</a></h3>
            
            <!-- Rating -->
            {% if block.settings.show_reviews %}
            <div class="ul-card-rating" data-random-reviews="true">
              <div class="ul-stars">â˜…â˜…â˜…â˜…â˜…</div>
              <span class="ul-rating-count"></span>
            </div>
            {% endif %}
            
            <!-- Price -->
            <div class="ul-card-price">
              {% if product.compare_at_price > product.price %}
                <span class="ul-compare-price">{{ product.compare_at_price | money }}</span>
              {% endif %}
              <span class="ul-current-price">{{ product.price | money }}</span>
            </div>
            
            <!-- UPLOAD BUTTON -->
            <button class="ul-upload-btn" type="button" onclick="openULModal(this)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>{{ block.settings.upload_text | default: 'Upload Design' }}</span>
            </button>
          </div>
        </div>
      {% else %}
        <p style="padding:20px;color:#666;">No products. Select a collection in block settings.</p>
      {% endfor %}
    </div>
    
    <!-- Nav Arrows -->
    <button class="ul-carousel-prev" onclick="slideCarousel('{{ block.id }}', -1)" aria-label="Previous">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    <button class="ul-carousel-next" onclick="slideCarousel('{{ block.id }}', 1)" aria-label="Next">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
    </button>
  </div>
</div>

<!-- Upload Modal -->
<div class="ul-modal-overlay" id="ulModalOverlay-{{ block.id }}">
  <div class="ul-modal">
    <div class="ul-modal-header">
      <h3>Upload Your Design</h3>
      <button class="ul-modal-close" onclick="closeULModal('{{ block.id }}')">Ã—</button>
    </div>
    <div class="ul-modal-body">
      <div class="ul-modal-product">
        <img src="" alt="" id="ulModalImg-{{ block.id }}" width="60" height="60">
        <div>
          <h4 id="ulModalTitle-{{ block.id }}">Product</h4>
          <span id="ulModalPrice-{{ block.id }}">$0.00</span>
        </div>
      </div>
      
      <div class="ul-upload-zone" id="ulUploadZone-{{ block.id }}" onclick="document.getElementById('ulFileInput-{{ block.id }}').click()">
        <input type="file" id="ulFileInput-{{ block.id }}" accept="image/*,.pdf" hidden onchange="handleULFile(event,'{{ block.id }}')">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#7367f0" stroke-width="1.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <p><strong>Drop your design here</strong></p>
        <p style="color:#666;font-size:13px">or click to browse</p>
      </div>
      
      <div class="ul-preview-zone" id="ulPreviewZone-{{ block.id }}" style="display:none">
        <img src="" alt="Preview" id="ulPreviewImg-{{ block.id }}" width="200" height="200">
        <button class="ul-remove-btn" onclick="removeULFile('{{ block.id }}')">Ã—</button>
      </div>
      
      <div class="ul-size-section">
        <label>Select Sheet Size:</label>
        <select class="ul-size-select" id="ulSizeSelect-{{ block.id }}" onchange="selectULSizeDropdown(this,'{{ block.id }}')">
          <option value="22x6" data-price="7.50">22" x 6" - $7.50</option>
          <option value="22x12" data-price="12.00" selected>22" x 12" - $12.00</option>
          <option value="22x24" data-price="22.00">22" x 24" - $22.00</option>
          <option value="22x60" data-price="50.00">22" x 60" - $50.00</option>
        </select>
      </div>
      
      <div class="ul-qty-row">
        <span>Quantity:</span>
        <div class="ul-qty-controls">
          <button type="button" onclick="changeULQty('{{ block.id }}',-1)">-</button>
          <input type="number" id="ulQtyInput-{{ block.id }}" value="1" min="1" onchange="updateULTotal('{{ block.id }}')">
          <button type="button" onclick="changeULQty('{{ block.id }}',1)">+</button>
        </div>
      </div>
    </div>
    
    <div class="ul-modal-footer">
      <button class="ul-modal-cart-btn" id="ulModalCartBtn-{{ block.id }}" onclick="addULToCart('{{ block.id }}')" disabled>
        Upload design to continue
      </button>
    </div>
  </div>
</div>

<style>
.ul-carousel-widget{padding:20px 0}
.ul-banner-box{text-align:center;padding:30px;background:linear-gradient(135deg,#f8f7ff 0%,#fff 100%);border-radius:16px;margin-bottom:30px}
.ul-banner-badge{background:linear-gradient(135deg,#ff6b6b 0%,#ff8e53 100%);color:#fff;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:600}
.ul-banner-title{font-size:32px;font-weight:800;margin:15px 0 5px;letter-spacing:6px;color:#333}
.ul-banner-text{color:#666;margin:0}
.ul-carousel-container{position:relative;padding:0 50px}
.ul-carousel-track{display:flex;gap:20px;overflow-x:auto;scroll-behavior:smooth;padding:20px 0;scrollbar-width:none}
.ul-carousel-track::-webkit-scrollbar{display:none}
.ul-carousel-card{flex:0 0 260px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 4px 20px rgba(0,0,0,.08);position:relative;transition:transform .3s,box-shadow .3s}
.ul-carousel-card:hover{transform:translateY(-5px);box-shadow:0 8px 30px rgba(115,103,240,.2)}
.ul-4d-badge{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,#7367f0 0%,#9e95f5 100%);color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700}
.ul-wishlist-btn{position:absolute;top:12px;right:12px;background:#fff;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.ul-wishlist-btn:hover{color:#ff6b6b}
.ul-card-image{margin-bottom:12px}
.ul-card-image img{width:100%;height:180px;object-fit:contain;border-radius:10px}
.ul-card-info{text-align:center}
.ul-card-info a{text-decoration:none;color:inherit}
.ul-card-vendor{color:#7367f0;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.ul-card-title{font-size:14px;font-weight:600;margin:6px 0;color:#333}
.ul-card-rating{display:flex;align-items:center;justify-content:center;gap:5px;margin-bottom:6px}
.ul-stars{color:#ffc107;font-size:12px}
.ul-rating-count{color:#999;font-size:11px}
.ul-card-price{margin-bottom:10px}
.ul-compare-price{color:#999;text-decoration:line-through;font-size:12px;margin-right:6px}
.ul-current-price{color:#7367f0;font-size:18px;font-weight:700}
.ul-upload-btn{width:100%;padding:10px;background:linear-gradient(135deg,#7367f0 0%,#9e95f5 100%);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:8px;transition:all .3s}
.ul-upload-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(115,103,240,.4)}
.ul-add-cart-btn{width:100%;padding:10px;background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);color:#333;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .3s}
.ul-add-cart-btn:hover{opacity:.9}
.ul-carousel-prev,.ul-carousel-next{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;background:#fff;border:none;border-radius:50%;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;z-index:10}
.ul-carousel-prev{left:0}
.ul-carousel-next{right:0}
.ul-carousel-prev:hover,.ul-carousel-next:hover{background:#7367f0;color:#fff}
.ul-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;visibility:hidden;transition:all .3s}
.ul-modal-overlay.active{opacity:1;visibility:visible}
.ul-modal{background:#fff;border-radius:16px;width:100%;max-width:400px;overflow:hidden;transform:scale(.9);transition:transform .3s}
.ul-modal-overlay.active .ul-modal{transform:scale(1)}
.ul-modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(135deg,#7367f0 0%,#9e95f5 100%);color:#fff}
.ul-modal-header h3{margin:0;font-size:16px}
.ul-modal-close{background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;font-size:18px;cursor:pointer}
.ul-modal-body{padding:18px}
.ul-modal-product{display:flex;align-items:center;gap:12px;padding:10px;background:#f8f9fa;border-radius:10px;margin-bottom:14px}
.ul-modal-product img{width:50px;height:50px;object-fit:cover;border-radius:8px}
.ul-modal-product h4{margin:0 0 4px;font-size:13px}
.ul-modal-product span{color:#7367f0;font-weight:600;font-size:14px}
.ul-upload-zone{border:2px dashed #7367f0;border-radius:12px;padding:25px;text-align:center;cursor:pointer;background:#f8f7ff;margin-bottom:14px;transition:all .3s}
.ul-upload-zone:hover{background:#f0eeff}
.ul-upload-zone p{margin:6px 0 0}
.ul-preview-zone{position:relative;margin-bottom:14px;text-align:center}
.ul-preview-zone img{max-width:100%;max-height:120px;border-radius:10px}
.ul-remove-btn{position:absolute;top:5px;right:5px;background:#ff4757;color:#fff;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px}
.ul-qty-row{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
.ul-qty-controls{display:flex;align-items:center;gap:8px}
.ul-qty-controls button{width:32px;height:32px;border:1px solid #ddd;border-radius:8px;background:#fff;font-size:16px;cursor:pointer}
.ul-qty-controls input{width:45px;text-align:center;border:1px solid #ddd;border-radius:8px;padding:6px;font-size:14px}
.ul-size-section{margin-bottom:14px}
.ul-size-section label{display:block;margin-bottom:8px;font-size:13px;font-weight:600}
.ul-size-select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;background:#fff;transition:border-color .2s}
.ul-size-select:focus{border-color:#7367f0;outline:none}
.ul-modal-footer{padding:14px 18px;background:#f8f9fa;border-top:1px solid #eee}
.ul-modal-cart-btn{width:100%;padding:12px;background:linear-gradient(135deg,#28c76f 0%,#48da89 100%);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer}
.ul-modal-cart-btn:disabled{background:#ccc;cursor:not-allowed}
</style>

<script defer>
(function(){
  window.ulData=window.ulData||{};
  // Random review counts
  document.querySelectorAll('[data-random-reviews]').forEach(function(el){
    var count=Math.floor(Math.random()*400)+50;
    el.querySelector('.ul-rating-count').textContent='('+count+')';
  });
  window.slideCarousel=function(id,dir){var t=document.getElementById('ulCarouselTrack-'+id);if(t)t.scrollBy({left:dir*280,behavior:'smooth'})};
  window.openULModal=function(btn){var c=btn.closest('.ul-carousel-card'),bid=btn.closest('.ul-carousel-widget').querySelector('[id^="ulCarouselTrack-"]').id.replace('ulCarouselTrack-','');if(c){ulData[bid]={vid:c.dataset.variantId,file:null,size:'22x12',sizePrice:12};document.getElementById('ulModalImg-'+bid).src=c.dataset.productImage;document.getElementById('ulModalTitle-'+bid).textContent=c.dataset.productTitle;document.getElementById('ulModalPrice-'+bid).textContent=c.dataset.productPrice}document.getElementById('ulModalOverlay-'+bid).classList.add('active');document.body.style.overflow='hidden'};
  window.closeULModal=function(bid){document.getElementById('ulModalOverlay-'+bid).classList.remove('active');document.body.style.overflow=''};
  window.handleULFile=function(e,bid){var f=e.target.files[0];if(!f)return;ulData[bid].file=f;document.getElementById('ulUploadZone-'+bid).style.display='none';document.getElementById('ulPreviewZone-'+bid).style.display='block';document.getElementById('ulPreviewImg-'+bid).src=URL.createObjectURL(f);document.getElementById('ulModalCartBtn-'+bid).disabled=false;document.getElementById('ulModalCartBtn-'+bid).textContent='Add to Cart'};
  window.removeULFile=function(bid){ulData[bid].file=null;document.getElementById('ulUploadZone-'+bid).style.display='';document.getElementById('ulPreviewZone-'+bid).style.display='none';document.getElementById('ulFileInput-'+bid).value='';document.getElementById('ulModalCartBtn-'+bid).disabled=true;document.getElementById('ulModalCartBtn-'+bid).textContent='Upload design to continue'};
  window.selectULSizeDropdown=function(sel,bid){var opt=sel.options[sel.selectedIndex];ulData[bid].size=opt.value;ulData[bid].sizePrice=parseFloat(opt.dataset.price)};
  window.changeULQty=function(bid,d){var i=document.getElementById('ulQtyInput-'+bid),v=parseInt(i.value)+d;if(v<1)v=1;i.value=v};
  window.addULToCart=function(bid){var btn=document.getElementById('ulModalCartBtn-'+bid),qty=parseInt(document.getElementById('ulQtyInput-'+bid).value)||1;btn.disabled=true;btn.textContent='Adding...';fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:[{id:ulData[bid].vid,quantity:qty,properties:{'_upload':ulData[bid].file?.name||'','_size':ulData[bid].size,'_unit_price':'$'+ulData[bid].sizePrice}}]})}).then(function(){btn.textContent='âœ“ Added!';setTimeout(function(){closeULModal(bid);window.location.href='/cart'},800)}).catch(function(){btn.disabled=false;btn.textContent='Add to Cart'})};
  document.addEventListener('click',function(e){if(e.target.classList.contains('ul-modal-overlay'))e.target.classList.remove('active')});
})();
</script>

{% schema %}
{
  "name": "3D Carousel 4D",
  "target": "section",
  "templates": ["index", "collection", "product", "page"],
  "settings": [
    {
      "type": "checkbox",
      "id": "show_banner",
      "label": "Show Banner",
      "default": false
    },
    {
      "type": "text",
      "id": "banner_badge",
      "label": "Badge Text",
      "default": "LIMITED TIME"
    },
    {
      "type": "text",
      "id": "banner_title",
      "label": "Title",
      "default": "BLACK FRIDAY"
    },
    {
      "type": "text",
      "id": "banner_text",
      "label": "Subtitle",
      "default": "Exclusive deals"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Products to Show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 6
    },
    {
      "type": "text",
      "id": "upload_text",
      "label": "Upload Button Text",
      "default": "Upload Design"
    },
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Reviews",
      "default": true
    }
  ]
}
{% endschema %}
