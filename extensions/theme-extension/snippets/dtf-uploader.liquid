{% comment %}
  DTF Uploader Snippet v4.1.0
  ============================
  FAZ 1: Core DTF Upload Widget
  FAZ 6: Mobile Experience
  
  Features:
  - Drag & Drop file upload
  - Shopify Variants for size selection (NOT manual input)
  - Quantity with +/- buttons
  - Extra questions from merchant config
  - T-Shirt addon button (if tshirtEnabled)
  - Add to Cart with line item properties
  - Price display
  
  Prepared for:
  - FAZ 2: T-Shirt Modal integration (openTShirtModal event)
  - FAZ 3: Confirmation Screen
  
  Usage: {% render 'dtf-uploader', product: product %}
{% endcomment %}

{% liquid
  assign api_base = "https://customizerapp.dev"
  assign shop_domain = shop.permanent_domain
  assign product_id = product.id
  assign current_variant = product.selected_or_first_available_variant
%}

{{ 'dtf-uploader.css' | asset_url | stylesheet_tag }}

<div 
  id="ul-dtf-{{ product.id }}"
  class="ul-dtf-uploader"
  data-api-base="{{ api_base }}"
  data-shop-domain="{{ shop_domain }}"
  data-product-id="{{ product.id }}"
  data-product-title="{{ product.title | escape }}"
>
  <!-- Loading State -->
  <div class="ul-loading active" id="ul-loading-{{ product.id }}">
    <div class="ul-loading-spinner"></div>
    <div>Loading configuration...</div>
  </div>

  <!-- Error Display -->
  <div class="ul-error" id="ul-error-{{ product.id }}">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 8v4m0 4h.01"/>
    </svg>
    <span id="ul-error-text-{{ product.id }}"></span>
  </div>

  <!-- Main Content -->
  <div id="ul-content-{{ product.id }}" style="display: none;">
    
    <!-- STEP 1: Upload Design -->
    <div class="ul-section" id="ul-upload-section-{{ product.id }}">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-1-{{ product.id }}">1</span>
        <span class="ul-section-title">Upload Your Design</span>
      </div>

      <!-- Dropzone -->
      <div class="ul-dropzone" id="ul-dropzone-{{ product.id }}">
        <input type="file" id="ul-file-input-{{ product.id }}" accept=".png,.jpg,.jpeg,.pdf,.svg,.webp,.ai,.eps">
        <svg class="ul-dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 16V4m0 0L8 8m4-4l4 4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="ul-dropzone-text">Drag & drop your design here</div>
        <div class="ul-dropzone-hint">or click to browse â€¢ PNG, JPG, SVG, PDF, AI, EPS â€¢ Max 50MB</div>
      </div>

      <!-- Upload Progress -->
      <div class="ul-upload-progress" id="ul-progress-{{ product.id }}">
        <div class="ul-progress-bar">
          <div class="ul-progress-fill" id="ul-progress-fill-{{ product.id }}"></div>
        </div>
        <div class="ul-progress-text" id="ul-progress-text-{{ product.id }}">Uploading...</div>
      </div>

      <!-- File Preview -->
      <div class="ul-file-preview" id="ul-preview-{{ product.id }}">
        <img class="ul-file-thumb" id="ul-thumb-{{ product.id }}" src="" alt="Preview" width="72" height="72">
        <div class="ul-file-info">
          <div class="ul-file-name" id="ul-filename-{{ product.id }}">design.png</div>
          <div class="ul-file-meta" id="ul-filemeta-{{ product.id }}">2400 x 3200 px â€¢ 300 DPI â€¢ 2.4 MB</div>
          <div class="ul-file-status" id="ul-filestatus-{{ product.id }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Ready for print</span>
          </div>
        </div>
        <button type="button" class="ul-file-remove" id="ul-remove-{{ product.id }}" aria-label="Remove file">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- STEP 2: Select Size (Shopify Variants) -->
    <div class="ul-section" id="ul-size-section-{{ product.id }}">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-2-{{ product.id }}">2</span>
        <span class="ul-section-title">Select Size</span>
        <span class="ul-section-subtitle" id="ul-size-hint-{{ product.id }}"></span>
      </div>

      <div class="ul-size-grid" id="ul-size-grid-{{ product.id }}">
        {% for variant in product.variants %}
          <label class="ul-size-option">
            <input 
              type="radio" 
              name="ul-variant-{{ product.id }}" 
              value="{{ variant.id }}"
              data-price="{{ variant.price | money_without_trailing_zeros }}"
              data-price-raw="{{ variant.price }}"
              data-title="{{ variant.title | escape }}"
              {% if variant.available == false %}disabled{% endif %}
              {% if forloop.first and variant.available %}checked{% endif %}
            >
            <div class="ul-size-card">
              <span class="ul-size-name">{{ variant.title }}</span>
              <span class="ul-size-price">{{ variant.price | money_without_trailing_zeros }}</span>
            </div>
            {% unless variant.available %}
              <span class="ul-size-badge">Sold Out</span>
            {% endunless %}
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- STEP 3: Quantity -->
    <div class="ul-section" id="ul-qty-section-{{ product.id }}">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-3-{{ product.id }}">3</span>
        <span class="ul-section-title">Quantity</span>
      </div>

      <div class="ul-quantity-row">
        <div class="ul-quantity-control">
          <button type="button" class="ul-qty-btn" id="ul-qty-minus-{{ product.id }}" aria-label="Decrease quantity">âˆ’</button>
          <input type="number" class="ul-qty-input" id="ul-qty-input-{{ product.id }}" value="1" min="1" max="999" aria-label="Quantity">
          <button type="button" class="ul-qty-btn" id="ul-qty-plus-{{ product.id }}" aria-label="Increase quantity">+</button>
        </div>
        <div class="ul-bulk-hint" id="ul-bulk-hint-{{ product.id }}" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
          </svg>
          <span>Bulk discount applied!</span>
        </div>
      </div>
    </div>

    <!-- STEP 4: Extra Questions (Dynamic from API) -->
    <div class="ul-section" id="ul-questions-section-{{ product.id }}" style="display: none;">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-4-{{ product.id }}">4</span>
        <span class="ul-section-title">Additional Options</span>
      </div>
      <div class="ul-questions-container" id="ul-questions-{{ product.id }}"></div>
    </div>

    <div class="ul-divider"></div>

    <!-- Price Summary -->
    <div class="ul-price-summary" id="ul-price-summary-{{ product.id }}">
      <div class="ul-price-row">
        <span class="ul-price-label">Size (<span id="ul-selected-size-{{ product.id }}">-</span>)</span>
        <span class="ul-price-value" id="ul-unit-price-{{ product.id }}">$0.00</span>
      </div>
      <div class="ul-price-row">
        <span class="ul-price-label">Quantity</span>
        <span class="ul-price-value">Ã— <span id="ul-qty-display-{{ product.id }}">1</span></span>
      </div>
      <div class="ul-price-row ul-price-total">
        <span class="ul-price-label">Total</span>
        <span class="ul-price-value ul-price-total" id="ul-total-price-{{ product.id }}">$0.00</span>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="ul-buttons-stack">
      <!-- T-Shirt Button (conditional) -->
      <button 
        type="button" 
        class="ul-btn ul-btn-secondary" 
        id="ul-tshirt-btn-{{ product.id }}"
        style="display: none;"
        disabled
      >
        <span>ðŸ‘•</span>
        <span class="ul-btn-text">I want this on a T-Shirt too!</span>
      </button>

      <!-- Add to Cart Button -->
      <button 
        type="button" 
        class="ul-btn ul-btn-primary" 
        id="ul-add-cart-{{ product.id }}"
        disabled
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>
        </svg>
        <span class="ul-btn-text">Add to Cart</span>
        <span class="ul-btn-price" id="ul-btn-price-{{ product.id }}"></span>
      </button>
    </div>

  </div>

  <!-- Hidden Form Fields for Cart -->
  <input type="hidden" id="ul-upload-id-{{ product.id }}" value="">
  <input type="hidden" id="ul-upload-url-{{ product.id }}" value="">
  <input type="hidden" id="ul-thumbnail-url-{{ product.id }}" value="">
</div>

<!-- Toast Notification -->
<div class="ul-toast" id="ul-toast">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
    <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <span id="ul-toast-text">Added to cart!</span>
</div>

<!-- FAZ 7: Error Handler (must load before other scripts) -->
<script src="{{ 'ul-error-handler.js' | asset_url }}" defer></script>
<script src="{{ 'dtf-uploader.js' | asset_url }}" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof ULDTFUploader !== 'undefined') {
      ULDTFUploader.init('{{ product.id }}');
    }
  });
</script>
