{% comment %}
  DTF Uploader Snippet v4.2.0
  ============================
  FAZ 1: Core DTF Upload Widget
  FAZ 6: Mobile Experience
  
  Features:
  - Drag & Drop file upload
  - Shopify Variants as DROPDOWN (not grid)
  - Quantity with +/- buttons
  - Extra questions from merchant config
  - T-Shirt addon button (if tshirtEnabled)
  - Add to Cart with line item properties
  - Price display
  - HIDES default Shopify Add to Cart, Checkout, Shop Pay buttons
  - HIDES default Shopify variant selectors
  
  Prepared for:
  - FAZ 2: T-Shirt Modal integration (openTShirtModal event)
  - FAZ 3: Confirmation Screen
  
  Usage: {% render 'dtf-uploader', product: product %}
{% endcomment %}

{% liquid
  comment
    API base URL - uses App Proxy for multi-store support
    Each store's app proxy routes to its own app instance
  endcomment
  assign api_base = "/apps/customizer"
  assign shop_domain = shop.permanent_domain
  assign product_id = product.id
  assign current_variant = product.selected_or_first_available_variant
%}

{{ 'dtf-uploader.css' | asset_url | stylesheet_tag }}

{% comment %} 
  ============================================================================
  ULTRA UNIVERSAL: Shopify VarsayÄ±lan Elementlerini Gizleme v2.0
  ============================================================================
  Bu sistem TÃœM Shopify temalarÄ±nda Ã§alÄ±ÅŸÄ±r:
  - Dawn, Debut, Brooklyn, Minimal, Supply, Sense, Taste, Studio
  - Premium temalar: Impulse, Turbo, Prestige, Motion, Symmetry
  - 3rd party temalar: Out of the Sandbox, Pixel Union, vb.
  
  YÃ¶ntem:
  1. CSS: Bilinen tÃ¼m seÃ§iciler + wildcard attribute selector'lar
  2. JavaScript: MutationObserver ile dinamik gizleme (geÃ§ yÃ¼klenen elementler iÃ§in)
  ============================================================================
{% endcomment %}

<style id="ul-hide-shopify-defaults">
  /* =========================================================================
     MEGA CSS SELECTOR LÄ°STESÄ° - TÃ¼m Shopify TemalarÄ±
     ========================================================================= */
  
  /* === ADD TO CART BUTONLARI === */
  /* Dawn / OS 2.0 Themes */
  .product-form__submit,
  .product-form__buttons,
  .product-form button[type="submit"],
  .product-form input[type="submit"],
  product-form button[type="submit"],
  
  /* Debut / Vintage Themes */
  .product__submit,
  .product-add-to-cart,
  .add-to-cart,
  .btn--add-to-cart,
  .product-form__cart-submit,
  .product-single__add-to-cart,
  #AddToCart,
  #add-to-cart,
  #addToCart,
  .AddToCart,
  
  /* Brooklyn / Narrative */
  .product-form__add-button,
  .product-form--add-to-cart,
  
  /* Premium Themes (Turbo, Impulse, etc) */
  .add_to_cart,
  .addtocart,
  .add-to-cart-btn,
  .add-to-cart-button,
  .product__add-to-cart-button,
  .product-submit,
  
  /* Form action based selectors */
  form[action="/cart/add"] > button[type="submit"],
  form[action="/cart/add"] > input[type="submit"],
  form[action="/cart/add"] button.btn,
  form[action*="/cart/add"] button[type="submit"],
  form[action*="/cart/add"] input[type="submit"],
  
  /* Attribute based (catches custom themes) */
  [data-add-to-cart],
  [data-add-to-cart-button],
  button[name="add"],
  button[data-action="add-to-cart"],
  
  /* === DYNAMIC CHECKOUT / SHOP PAY / ACCELERATED CHECKOUT === */
  .shopify-payment-button,
  .shopify-payment-button__button,
  .shopify-payment-button__more-options,
  .shopify-payment-button__button--unbranded,
  .shopify-payment-button__button--branded,
  [data-shopify="payment-button"],
  [data-shopify-buttoncontainer],
  .dynamic-checkout,
  .dynamic-checkout__content,
  .dynamic-checkout__buttons,
  .dynamic-checkout-buttons,
  
  /* Shop Pay specific */
  .shopify-cleanslate,
  shopify-accelerated-checkout,
  shopify-accelerated-checkout-cart,
  shopify-buy-it-now,
  .shopify-accelerated-checkout,
  
  /* Additional checkout buttons (Apple Pay, Google Pay, etc) */
  .additional-checkout-buttons,
  .additional-checkout-button,
  .additional-payment-buttons,
  #shopify-payment-button,
  
  /* Buy Now / Buy It Now */
  .product-form__buy-now,
  .buy-now-button,
  .buy-it-now,
  .buy-now,
  [data-buy-now],
  
  /* Payment Terms (Affirm, Klarna, etc) */
  .payment-terms,
  .product__payment-terms,
  .afterpay-paragraph,
  #shopify-installments,
  shopify-payment-terms,
  
  /* === VARIANT SELECTORS === */
  /* Dawn / OS 2.0 */
  .product-form__input,
  .product-form__option,
  .product-form__controls,
  .product-form__controls-group,
  variant-selects,
  variant-radios,
  .variant-input-wrapper,
  
  /* Debut / Classic themes */
  .variant-wrapper,
  .variant-input-wrap,
  .selector-wrapper,
  .single-option-selector,
  .product-single__variants,
  .product-variants,
  .product__variants,
  
  /* Swatch / Color selectors */
  .swatch,
  .swatches,
  .swatch-element,
  .color-swatch,
  .color-swatches,
  .product-form__swatch,
  
  /* Size selectors */
  .size-selector,
  .size-swatches,
  .product-form__size,
  
  /* Option selectors */
  [data-variant-option],
  [data-option-selector],
  [data-single-option-selector],
  .product-option,
  .product-options,
  .option-selector,
  
  /* Variant picker components */
  .product-variant-picker,
  .variant-picker,
  .variant-selector,
  variant-picker,
  product-variant-picker,
  
  /* Premium theme selectors */
  .product__option,
  .product__options,
  .product-block-options,
  fieldset.product-form__input,
  .js-variant-selector,
  
  /* === QUANTITY SELECTORS (we have our own) === */
  .product-form__quantity,
  .quantity-selector,
  .quantity-wrapper,
  .quantity__wrapper,
  .quantity-input-wrap,
  .product__quantity,
  quantity-input,
  .quantity-input,
  .quantity-controls,
  [data-quantity-wrapper],
  
  /* === PRODUCT FORM (if needed to hide entire form) === */
  /* Uncomment below if you want to hide the entire form:
  product-form,
  .product-form,
  .product-single__form,
  */
  
  /* === INSTALLMENT/PAYMENT TERMS === */
  .installment,
  .product-form__installment,
  #installment-price,
  
  /* === GIFT CARD RECIPIENT (if enabled) === */
  .product-form__gift-card,
  .gift-card-recipient {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    height: 0 !important;
    max-height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    position: absolute !important;
    left: -9999px !important;
    width: 0 !important;
  }
  
  /* === SHADOW DOM / WEB COMPONENTS Ä°Ã‡Ä°N EKSTRA === */
  /* BazÄ± temalar Shadow DOM kullanÄ±yor, ::part ile eriÅŸim */
  shopify-payment-button::part(button),
  shopify-accelerated-checkout::part(button) {
    display: none !important;
  }
</style>

{% comment %} 
  JavaScript ile Dinamik Gizleme
  MutationObserver kullanarak geÃ§ yÃ¼klenen elementleri de yakalar
{% endcomment %}
<script>
(function() {
  'use strict';
  
  // Gizlenecek element seÃ§icileri (CSS'te olmayanlar veya dinamik olanlar)
  const HIDE_SELECTORS = [
    // Add to Cart
    'button[name="add"]',
    'button[type="submit"][form*="product"]',
    '.product-form button[type="submit"]',
    'form[action="/cart/add"] button',
    'form[action*="/cart/add"] button[type="submit"]',
    
    // Shopify Payment Buttons
    '.shopify-payment-button',
    'shopify-payment-button',
    'shopify-accelerated-checkout',
    '[data-shopify="payment-button"]',
    
    // Variant Selectors
    'variant-selects',
    'variant-radios',
    'variant-picker',
    '.variant-wrapper',
    '.product-form__input',
    '.selector-wrapper',
    
    // Quantity
    'quantity-input',
    '.product-form__quantity'
  ];
  
  // Element'i gizle
  function hideElement(el) {
    if (el && !el.dataset.ulHidden) {
      el.style.cssText = 'display:none!important;visibility:hidden!important;height:0!important;overflow:hidden!important;position:absolute!important;left:-9999px!important;';
      el.dataset.ulHidden = 'true';
    }
  }
  
  // TÃ¼m eÅŸleÅŸen elementleri bul ve gizle
  function hideAllMatching() {
    HIDE_SELECTORS.forEach(selector => {
      try {
        document.querySelectorAll(selector).forEach(hideElement);
      } catch(e) {
        // Invalid selector, skip
      }
    });
    
    // Ã–zel durumlar: Text iÃ§eriÄŸine gÃ¶re buton bulma
    document.querySelectorAll('button, input[type="submit"]').forEach(btn => {
      const text = (btn.textContent || btn.value || '').toLowerCase();
      if (
        text.includes('add to cart') ||
        text.includes('add to bag') ||
        text.includes('buy now') ||
        text.includes('buy it now') ||
        text.includes('sepete ekle') ||
        text.includes('satÄ±n al')
      ) {
        // Bizim butonumuz deÄŸilse gizle
        if (!btn.closest('.ul-dtf-uploader') && !btn.closest('#ul-tshirt-modal')) {
          hideElement(btn);
        }
      }
    });
    
    // Shopify accelerated checkout iframes
    document.querySelectorAll('iframe[src*="shopify"]').forEach(iframe => {
      if (iframe.src.includes('payment') || iframe.src.includes('checkout')) {
        hideElement(iframe.parentElement);
      }
    });
  }
  
  // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', hideAllMatching);
  } else {
    hideAllMatching();
  }
  
  // Window load'da tekrar Ã§alÄ±ÅŸtÄ±r (lazy loaded iÃ§in)
  window.addEventListener('load', function() {
    setTimeout(hideAllMatching, 100);
    setTimeout(hideAllMatching, 500);
    setTimeout(hideAllMatching, 1000);
  });
  
  // MutationObserver: DOM deÄŸiÅŸikliklerini izle
  const observer = new MutationObserver(function(mutations) {
    let shouldHide = false;
    mutations.forEach(mutation => {
      if (mutation.addedNodes.length > 0) {
        shouldHide = true;
      }
    });
    if (shouldHide) {
      // Debounce
      clearTimeout(window._ulHideTimeout);
      window._ulHideTimeout = setTimeout(hideAllMatching, 50);
    }
  });
  
  // Body'yi izlemeye baÅŸla
  if (document.body) {
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    });
  }
  
  // Global eriÅŸim iÃ§in (debug amaÃ§lÄ±)
  window.ULHideShopifyDefaults = {
    hide: hideAllMatching,
    selectors: HIDE_SELECTORS
  };
  
  console.log('[UL] Shopify default elements hiding system initialized');
})();
</script>

<div 
  id="ul-dtf-{{ product.id }}"
  class="ul-dtf-uploader"
  data-api-base="{{ api_base }}"
  data-shop-domain="{{ shop_domain }}"
  data-product-id="{{ product.id }}"
  data-product-title="{{ product.title | escape }}"
>
  <!-- Loading State -->
  <div class="ul-loading active" id="ul-loading-{{ product.id }}">
    <div class="ul-loading-spinner"></div>
    <div>Loading configuration...</div>
  </div>

  <!-- Error Display -->
  <div class="ul-error" id="ul-error-{{ product.id }}">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 8v4m0 4h.01"/>
    </svg>
    <span id="ul-error-text-{{ product.id }}"></span>
  </div>

  <!-- Main Content -->
  <div id="ul-content-{{ product.id }}" style="display: none;">
    
    <!-- STEP 1: Upload Design -->
    <div class="ul-section" id="ul-upload-section-{{ product.id }}">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-1-{{ product.id }}">1</span>
        <span class="ul-section-title">Upload Your Design</span>
      </div>

      <!-- Dropzone -->
      <div class="ul-dropzone" id="ul-dropzone-{{ product.id }}">
        <input type="file" id="ul-file-input-{{ product.id }}" accept=".png,.jpg,.jpeg,.webp,.tiff,.tif,.psd,.svg,.pdf,.ai,.eps">
        <svg class="ul-dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 16V4m0 0L8 8m4-4l4 4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="ul-dropzone-text">Drag & drop your design here</div>
        <div class="ul-dropzone-hint">or click to browse â€¢ PNG, JPG, WEBP, TIFF, PSD, PDF, AI, EPS â€¢ Max 1GB</div>
      </div>

      <!-- Upload Progress -->
      <div class="ul-upload-progress" id="ul-progress-{{ product.id }}">
        <div class="ul-progress-bar">
          <div class="ul-progress-fill" id="ul-progress-fill-{{ product.id }}"></div>
        </div>
        <div class="ul-progress-info">
          <div class="ul-progress-text" id="ul-progress-text-{{ product.id }}">Uploading...</div>
          <button type="button" class="ul-cancel-upload" id="ul-cancel-upload-{{ product.id }}" title="Cancel Upload">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
            </svg>
            Cancel
          </button>
        </div>
      </div>

      <!-- File Preview -->
      <div class="ul-file-preview" id="ul-preview-{{ product.id }}">
        <img class="ul-file-thumb" id="ul-thumb-{{ product.id }}" src="" alt="Preview" width="72" height="72">
        <div class="ul-file-info">
          <div class="ul-file-name" id="ul-filename-{{ product.id }}">design.png</div>
          <div class="ul-file-meta" id="ul-filemeta-{{ product.id }}">2400 x 3200 px â€¢ 300 DPI â€¢ 2.4 MB</div>
          <div class="ul-file-status" id="ul-filestatus-{{ product.id }}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Ready for print</span>
          </div>
        </div>
        <button type="button" class="ul-file-remove" id="ul-remove-{{ product.id }}" aria-label="Remove file">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- STEP 2: Select Options (Separate dropdown for each option) -->
    <div class="ul-section" id="ul-options-section-{{ product.id }}">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-2-{{ product.id }}">2</span>
        <span class="ul-section-title">Select Options</span>
      </div>

      <!-- Render each product option as separate dropdown -->
      {% for option in product.options_with_values %}
        <div class="ul-option-dropdown-group" data-option-index="{{ forloop.index0 }}">
          <label class="ul-option-dropdown-label">{{ option.name }}</label>
          <div class="ul-option-dropdown-wrapper">
            <select 
              class="ul-option-dropdown" 
              id="ul-option-{{ product.id }}-{{ forloop.index0 }}"
              data-option-index="{{ forloop.index0 }}"
              data-product-id="{{ product.id }}"
            >
              {% for value in option.values %}
                <option 
                  value="{{ value | escape }}"
                  {% if option.selected_value == value %}selected{% endif %}
                >
                  {{ value }}
                </option>
              {% endfor %}
            </select>
            <svg class="ul-option-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      {% endfor %}

      <!-- Selected Variant Display -->
      <div class="ul-selected-variant-display" id="ul-selected-variant-{{ product.id }}">
        <span class="ul-variant-name-display" id="ul-variant-name-{{ product.id }}">{{ current_variant.title }}</span>
        <span class="ul-variant-price-display" id="ul-variant-price-{{ product.id }}">{{ current_variant.price | money_without_trailing_zeros }}</span>
      </div>

      <!-- Hidden input for selected variant ID -->
      <input type="hidden" id="ul-size-select-{{ product.id }}" value="{{ current_variant.id }}" data-price-raw="{{ current_variant.price }}">
    </div>

    <!-- Variant JSON Data for JS -->
    <script type="application/json" id="ul-variants-json-{{ product.id }}">
      {{ product.variants | json }}
    </script>

    <!-- STEP 3: Quantity -->
    <div class="ul-section" id="ul-qty-section-{{ product.id }}">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-3-{{ product.id }}">3</span>
        <span class="ul-section-title">Quantity</span>
      </div>

      <div class="ul-quantity-row">
        <div class="ul-quantity-control">
          <button type="button" class="ul-qty-btn" id="ul-qty-minus-{{ product.id }}" aria-label="Decrease quantity">âˆ’</button>
          <input type="number" class="ul-qty-input" id="ul-qty-input-{{ product.id }}" value="1" min="1" max="999" aria-label="Quantity">
          <button type="button" class="ul-qty-btn" id="ul-qty-plus-{{ product.id }}" aria-label="Increase quantity">+</button>
        </div>
        <div class="ul-bulk-hint" id="ul-bulk-hint-{{ product.id }}" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
          </svg>
          <span>Bulk discount applied!</span>
        </div>
      </div>
    </div>

    <!-- STEP 4: Extra Questions (Dynamic from API) -->
    <div class="ul-section" id="ul-questions-section-{{ product.id }}" style="display: none;">
      <div class="ul-section-header">
        <span class="ul-step-badge" id="ul-step-4-{{ product.id }}">4</span>
        <span class="ul-section-title">Additional Options</span>
      </div>
      <div class="ul-questions-container" id="ul-questions-{{ product.id }}"></div>
    </div>

    <div class="ul-divider"></div>

    <!-- Price Summary -->
    <div class="ul-price-summary" id="ul-price-summary-{{ product.id }}">
      <div class="ul-price-row">
        <span class="ul-price-label">Size (<span id="ul-selected-size-{{ product.id }}">-</span>)</span>
        <span class="ul-price-value" id="ul-unit-price-{{ product.id }}">$0.00</span>
      </div>
      <div class="ul-price-row">
        <span class="ul-price-label">Quantity</span>
        <span class="ul-price-value">Ã— <span id="ul-qty-display-{{ product.id }}">1</span></span>
      </div>
      <div class="ul-price-row ul-price-total">
        <span class="ul-price-label">Total</span>
        <span class="ul-price-value ul-price-total" id="ul-total-price-{{ product.id }}">$0.00</span>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="ul-buttons-stack">
      <!-- T-Shirt Button (conditional) -->
      <button 
        type="button" 
        class="ul-btn ul-btn-secondary" 
        id="ul-tshirt-btn-{{ product.id }}"
        style="display: none;"
        disabled
      >
        <span>ðŸ‘•</span>
        <span class="ul-btn-text">I want this on a T-Shirt too!</span>
      </button>

      <!-- Add to Cart Button -->
      <button 
        type="button" 
        class="ul-btn ul-btn-primary" 
        id="ul-add-cart-{{ product.id }}"
        disabled
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>
        </svg>
        <span class="ul-btn-text">Add to Cart</span>
        <span class="ul-btn-price" id="ul-btn-price-{{ product.id }}"></span>
      </button>
    </div>

  </div>

  <!-- Hidden Form Fields for Cart -->
  <input type="hidden" id="ul-upload-id-{{ product.id }}" value="">
  <input type="hidden" id="ul-upload-url-{{ product.id }}" value="">
  <input type="hidden" id="ul-thumbnail-url-{{ product.id }}" value="">
</div>

<!-- Toast Notification -->
<div class="ul-toast" id="ul-toast">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
    <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <span id="ul-toast-text">Added to cart!</span>
</div>

<!-- FAZ 8: Analytics (must load before components) -->
<script src="{{ 'ul-analytics.js' | asset_url }}" defer></script>
<!-- FAZ 7: Error Handler (must load before other scripts) -->
<script src="{{ 'ul-error-handler.js' | asset_url }}" defer></script>
<script src="{{ 'dtf-uploader.js' | asset_url }}" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof ULDTFUploader !== 'undefined') {
      ULDTFUploader.init('{{ product.id }}');
    }
  });
</script>
