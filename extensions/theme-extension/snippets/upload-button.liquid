{% comment %}
  Upload Lift - Product Upload Button Snippet
  Renders an upload button that opens a modal for custom design upload
  
  Usage: {% render 'upload-button', product: product %}
{% endcomment %}

<style>
  .ul-upload-btn-wrapper {
    margin: 10px 0;
  }
  
  .ul-upload-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 12px 20px;
    background: linear-gradient(135deg, #7367f0 0%, #9e95f5 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(115, 103, 240, 0.3);
  }
  
  .ul-upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(115, 103, 240, 0.4);
  }
  
  .ul-upload-btn svg {
    width: 18px;
    height: 18px;
  }

  /* Upload Modal Styles */
  .ul-upload-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .ul-upload-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .ul-upload-modal {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s ease;
  }
  
  .ul-upload-modal-overlay.active .ul-upload-modal {
    transform: scale(1) translateY(0);
  }
  
  .ul-upload-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid #eee;
    background: linear-gradient(135deg, #7367f0 0%, #9e95f5 100%);
    color: white;
  }
  
  .ul-upload-modal-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }
  
  .ul-upload-modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  
  .ul-upload-modal-close:hover {
    background: rgba(255,255,255,0.3);
  }
  
  .ul-upload-modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }
  
  .ul-modal-product-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 16px;
  }
  
  .ul-modal-product-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
  }
  
  .ul-modal-product-title {
    font-weight: 600;
    font-size: 14px;
    margin: 0 0 4px 0;
  }
  
  .ul-modal-product-price {
    color: #7367f0;
    font-weight: 600;
  }
  
  .ul-upload-zone {
    border: 2px dashed #7367f0;
    border-radius: 12px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f7ff;
    margin-bottom: 16px;
  }
  
  .ul-upload-zone:hover {
    background: #f0eeff;
    border-color: #5a4fd1;
  }
  
  .ul-upload-zone.dragover {
    background: #e8e5ff;
    border-color: #5a4fd1;
  }
  
  .ul-upload-zone-icon {
    color: #7367f0;
    margin-bottom: 10px;
  }
  
  .ul-upload-zone-text {
    font-weight: 600;
    margin: 0 0 5px 0;
    color: #333;
  }
  
  .ul-upload-zone-subtext {
    color: #666;
    font-size: 13px;
    margin: 0;
  }
  
  .ul-upload-preview {
    display: none;
    position: relative;
    margin-bottom: 16px;
  }
  
  .ul-upload-preview.active {
    display: block;
  }
  
  .ul-upload-preview img {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: 10px;
    background: #f5f5f5;
  }
  
  .ul-upload-preview-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ff4757;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .ul-size-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .ul-size-btn {
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  
  .ul-size-btn:hover {
    border-color: #7367f0;
  }
  
  .ul-size-btn.active {
    border-color: #7367f0;
    background: #f8f7ff;
  }
  
  .ul-size-name {
    display: block;
    font-weight: 600;
    font-size: 14px;
  }
  
  .ul-size-price {
    display: block;
    color: #7367f0;
    font-size: 13px;
    margin-top: 2px;
  }
  
  .ul-qty-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  
  .ul-qty-label {
    font-weight: 600;
  }
  
  .ul-qty-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .ul-qty-btn {
    width: 36px;
    height: 36px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: white;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .ul-qty-btn:hover {
    background: #f5f5f5;
  }
  
  .ul-qty-input {
    width: 50px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 8px;
    font-size: 16px;
    font-weight: 600;
  }
  
  .ul-modal-footer {
    padding: 16px 20px;
    border-top: 1px solid #eee;
    background: #f8f9fa;
  }
  
  .ul-total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .ul-total-label {
    font-weight: 600;
  }
  
  .ul-total-price {
    font-size: 20px;
    font-weight: 700;
    color: #7367f0;
  }
  
  .ul-add-to-cart-modal {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #28c76f 0%, #48da89 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .ul-add-to-cart-modal:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 199, 111, 0.3);
  }
  
  .ul-add-to-cart-modal:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
</style>

<!-- Upload Button -->
<div class="ul-upload-btn-wrapper" data-product-id="{{ product.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
  <button class="ul-upload-btn" type="button" onclick="openUploadModal(this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    <span>{{ button_text | default: 'Upload Your Design' }}</span>
  </button>
</div>

<!-- Upload Modal (only render once) -->
{% unless ul_modal_rendered %}
<div class="ul-upload-modal-overlay" id="ulUploadModalOverlay">
  <div class="ul-upload-modal">
    <div class="ul-upload-modal-header">
      <h3 class="ul-upload-modal-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Upload Your Design
      </h3>
      <button class="ul-upload-modal-close" onclick="closeUploadModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="ul-upload-modal-body">
      <!-- Product Info -->
      <div class="ul-modal-product-info">
        <img src="" alt="" class="ul-modal-product-img" id="ulModalProductImg">
        <div>
          <h4 class="ul-modal-product-title" id="ulModalProductTitle">Product</h4>
          <span class="ul-modal-product-price" id="ulModalProductPrice">$0.00</span>
        </div>
      </div>
      
      <!-- Upload Zone -->
      <div class="ul-upload-zone" id="ulUploadZone" onclick="document.getElementById('ulFileInput').click()">
        <input type="file" id="ulFileInput" accept="image/*,.pdf,.svg" hidden onchange="handleFileSelect(event)">
        <div class="ul-upload-zone-icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <p class="ul-upload-zone-text">Drag & drop your design here</p>
        <p class="ul-upload-zone-subtext">or click to browse (PNG, JPG, PDF, SVG)</p>
      </div>
      
      <!-- Upload Preview -->
      <div class="ul-upload-preview" id="ulUploadPreview">
        <img src="" alt="Preview" id="ulPreviewImg">
        <button class="ul-upload-preview-remove" onclick="removeUpload()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      
      <!-- Size Selection -->
      <label style="display:block;font-weight:600;margin-bottom:8px;">Select Sheet Size:</label>
      <div class="ul-size-grid">
        <button class="ul-size-btn" data-size="22x6" data-price="7.50" onclick="selectSize(this)">
          <span class="ul-size-name">22" x 6"</span>
          <span class="ul-size-price">$7.50</span>
        </button>
        <button class="ul-size-btn active" data-size="22x12" data-price="12.00" onclick="selectSize(this)">
          <span class="ul-size-name">22" x 12"</span>
          <span class="ul-size-price">$12.00</span>
        </button>
        <button class="ul-size-btn" data-size="22x24" data-price="22.00" onclick="selectSize(this)">
          <span class="ul-size-name">22" x 24"</span>
          <span class="ul-size-price">$22.00</span>
        </button>
        <button class="ul-size-btn" data-size="22x60" data-price="50.00" onclick="selectSize(this)">
          <span class="ul-size-name">22" x 60"</span>
          <span class="ul-size-price">$50.00</span>
        </button>
      </div>
      
      <!-- Quantity -->
      <div class="ul-qty-row">
        <span class="ul-qty-label">Quantity:</span>
        <div class="ul-qty-controls">
          <button class="ul-qty-btn" onclick="changeQty(-1)">-</button>
          <input type="number" class="ul-qty-input" id="ulQtyInput" value="1" min="1" onchange="updateTotal()">
          <button class="ul-qty-btn" onclick="changeQty(1)">+</button>
        </div>
      </div>
    </div>
    
    <div class="ul-modal-footer">
      <div class="ul-total-row">
        <span class="ul-total-label">Total:</span>
        <span class="ul-total-price" id="ulTotalPrice">$12.00</span>
      </div>
      <button class="ul-add-to-cart-modal" id="ulAddToCartBtn" onclick="addToCartWithUpload()" disabled>
        Upload design to continue
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  // State
  window.ulModalState = window.ulModalState || {
    productId: null,
    variantId: null,
    productTitle: '',
    productPrice: 0,
    productImage: '',
    uploadedFile: null,
    uploadedUrl: null,
    selectedSize: '22x12',
    selectedPrice: 12.00,
    quantity: 1
  };

  // Open modal
  window.openUploadModal = function(btn) {
    const wrapper = btn.closest('.ul-upload-btn-wrapper');
    const card = btn.closest('.ul-product-card-4d, .ul-product-card, [data-product-id]');
    
    // Get product info
    if (wrapper) {
      ulModalState.productId = wrapper.dataset.productId;
      ulModalState.variantId = wrapper.dataset.variantId;
    }
    
    if (card) {
      ulModalState.productId = card.dataset.productId || ulModalState.productId;
      ulModalState.variantId = card.dataset.variantId || ulModalState.variantId;
      ulModalState.productTitle = card.dataset.productTitle || card.querySelector('.ul-product-title, h3, h4')?.textContent || 'Product';
      ulModalState.productImage = card.dataset.productImage || card.querySelector('img')?.src || '';
      
      const priceEl = card.querySelector('.ul-current-price, .ul-modal-product-price, [class*="price"]');
      if (priceEl) {
        const priceMatch = priceEl.textContent.match(/[\d.,]+/);
        ulModalState.productPrice = priceMatch ? parseFloat(priceMatch[0].replace(',', '')) : 0;
      }
    }
    
    // Update modal
    document.getElementById('ulModalProductImg').src = ulModalState.productImage;
    document.getElementById('ulModalProductTitle').textContent = ulModalState.productTitle;
    document.getElementById('ulModalProductPrice').textContent = '$' + ulModalState.productPrice.toFixed(2);
    
    // Show modal
    document.getElementById('ulUploadModalOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    updateTotal();
  };

  // Close modal
  window.closeUploadModal = function() {
    document.getElementById('ulUploadModalOverlay').classList.remove('active');
    document.body.style.overflow = '';
  };

  // Close on overlay click
  document.getElementById('ulUploadModalOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) closeUploadModal();
  });

  // Close on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeUploadModal();
  });

  // File handling
  window.handleFileSelect = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    ulModalState.uploadedFile = file;
    ulModalState.uploadedUrl = URL.createObjectURL(file);
    
    document.getElementById('ulUploadZone').style.display = 'none';
    const preview = document.getElementById('ulUploadPreview');
    preview.classList.add('active');
    document.getElementById('ulPreviewImg').src = ulModalState.uploadedUrl;
    
    document.getElementById('ulAddToCartBtn').disabled = false;
    document.getElementById('ulAddToCartBtn').textContent = 'Add to Cart';
  };

  window.removeUpload = function() {
    ulModalState.uploadedFile = null;
    ulModalState.uploadedUrl = null;
    
    document.getElementById('ulUploadZone').style.display = '';
    document.getElementById('ulUploadPreview').classList.remove('active');
    document.getElementById('ulFileInput').value = '';
    
    document.getElementById('ulAddToCartBtn').disabled = true;
    document.getElementById('ulAddToCartBtn').textContent = 'Upload design to continue';
  };

  // Drag & drop
  const zone = document.getElementById('ulUploadZone');
  if (zone) {
    zone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    zone.addEventListener('dragleave', function() {
      this.classList.remove('dragover');
    });
    zone.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        document.getElementById('ulFileInput').files = e.dataTransfer.files;
        handleFileSelect({ target: { files: e.dataTransfer.files } });
      }
    });
  }

  // Size selection
  window.selectSize = function(btn) {
    document.querySelectorAll('.ul-size-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    ulModalState.selectedSize = btn.dataset.size;
    ulModalState.selectedPrice = parseFloat(btn.dataset.price);
    updateTotal();
  };

  // Quantity
  window.changeQty = function(delta) {
    const input = document.getElementById('ulQtyInput');
    let val = parseInt(input.value) + delta;
    if (val < 1) val = 1;
    input.value = val;
    ulModalState.quantity = val;
    updateTotal();
  };

  window.updateTotal = function() {
    const input = document.getElementById('ulQtyInput');
    ulModalState.quantity = parseInt(input.value) || 1;
    const total = ulModalState.selectedPrice * ulModalState.quantity;
    document.getElementById('ulTotalPrice').textContent = '$' + total.toFixed(2);
  };

  // Add to cart
  window.addToCartWithUpload = async function() {
    const btn = document.getElementById('ulAddToCartBtn');
    btn.disabled = true;
    btn.textContent = 'Adding...';
    
    try {
      // Add to cart with properties
      const formData = {
        items: [{
          id: ulModalState.variantId,
          quantity: ulModalState.quantity,
          properties: {
            '_upload_file': ulModalState.uploadedFile?.name || 'design',
            '_sheet_size': ulModalState.selectedSize,
            '_sheet_price': '$' + ulModalState.selectedPrice.toFixed(2),
            'Design': 'Custom Upload'
          }
        }]
      };
      
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        btn.textContent = 'âœ“ Added!';
        setTimeout(() => {
          closeUploadModal();
          removeUpload();
          btn.disabled = true;
          btn.textContent = 'Upload design to continue';
          // Refresh cart
          window.location.href = '/cart';
        }, 1000);
      } else {
        throw new Error('Failed to add to cart');
      }
    } catch (err) {
      console.error(err);
      btn.disabled = false;
      btn.textContent = 'Add to Cart';
      alert('Failed to add to cart. Please try again.');
    }
  };
})();
</script>
{% assign ul_modal_rendered = true %}
{% endunless %}
